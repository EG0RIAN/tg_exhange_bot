# Final Verification - –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚úÖ

#### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫—É—Ä—Å–æ–≤
```sql
SELECT code, name, enabled FROM fx_source;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
grinex | Grinex Exchange | true
rapira | Rapira Exchange | true
```

#### –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
```sql
SELECT internal_symbol, COUNT(*) as sources 
FROM fx_source_pair 
WHERE enabled = true 
GROUP BY internal_symbol;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
BTC/USDT | 2 (grinex + rapira)
USD/RUB  | 2 (grinex + rapira)
USDT/RUB | 2 (grinex + rapira)
```

#### –ù–∞—Ü–µ–Ω–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
```sql
SELECT percent, description 
FROM fx_markup_rule 
WHERE description ILIKE '%–≥–æ—Ä–æ–¥%' 
ORDER BY percent;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
0.0% | –ú–æ—Å–∫–≤–∞
0.3% | –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
0.7% | –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥
0.8% | –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥
0.9% | –ö–∞–∑–∞–Ω—å
1.0% | –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É
1.5% | –î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞
```

### 2. API Endpoints ‚úÖ

#### –ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å Rapira
```bash
curl "http://localhost:8000/api/test/rapira-base-rate?symbol=USDT/RUB"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "best_ask": 81.81,
  "best_bid": 81.78
}
```

#### –ö—É—Ä—Å—ã –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
```bash
# –¢—Ä–µ–±—É–µ—Ç login
GET /api/city-rates/all?symbol=USDT/RUB&operation=buy
```

### 3. –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã ‚úÖ

#### –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–æ—Ç–µ

**–®–∞–≥ 1: –ü—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—Å–æ–≤**
```
–ö–Ω–æ–ø–∫–∞ "üí± –ö—É—Ä—Å—ã"
  ‚Üì
–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (7 –∫–Ω–æ–ø–æ–∫)
  ‚Üì
–ö—É—Ä—Å—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
  - USDT/RUB: –ü–æ–∫—É–ø–∫–∞ 82.63 ‚ÇΩ, –ü—Ä–æ–¥–∞–∂–∞ 82.57 ‚ÇΩ
  - BTC/USDT: –ö—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞
  - USD/RUB: –ö—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞
```

**–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏**
```
–ö–Ω–æ–ø–∫–∞ "‚úâÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
  ‚Üì
1. –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (–º–æ—Å–∫–≤–∞/—Ä–æ—Å—Ç–æ–≤/—Å–ø–±...)
  ‚Üì
2. –í—ã–±–æ—Ä –ø–∞—Ä—ã (USDT/RUB, BTC/USDT, USD/RUB)
  ‚Üì
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—É—Ä—Å:
   üí∞ –í–∞—à –∫—É—Ä—Å: 82.63 ‚ÇΩ
   ‚îî –ë–∞–∑–æ–≤—ã–π: 81.81 ‚ÇΩ
   ‚îî –ù–∞—Ü–µ–Ω–∫–∞: +1%
   ‚îî –ò—Å—Ç–æ—á–Ω–∏–∫: RAPIRA
  ‚Üì
4. –°—É–º–º–∞, –≤—ã–ø–ª–∞—Ç–∞, –∫–æ–Ω—Ç–∞–∫—Ç
  ‚Üì
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
  ‚Üì
6. –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å rate_snapshot:
   {
     "city": "rostov",
     "final_rate": 82.63,
     "base_rate": 81.81,
     "markup_percent": 1.0,
     "source": "rapira"
   }
```

### 4. –í—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∫—É—Ä—Å–∞ ‚úÖ

**–ê–ª–≥–æ—Ä–∏—Ç–º (src/services/best_rate.py):**

```python
# 1. –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å—ã
rapira = 81.81 ‚ÇΩ
grinex = 81.90 ‚ÇΩ (–∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

# 2. –î–ª—è operation="buy" (–∫–ª–∏–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç)
if rapira and grinex:
    base = min(81.81, 81.90) = 81.81 ‚ÇΩ  # Rapira –ª—É—á—à–µ!
elif rapira:
    base = 81.81 ‚ÇΩ  # –¢–æ–ª—å–∫–æ Rapira –¥–æ—Å—Ç—É–ø–µ–Ω
    
# 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Ü–µ–Ω–∫—É –≥–æ—Ä–æ–¥–∞ (–†–æ—Å—Ç–æ–≤ +1%)
final = 81.81 √ó 1.01 = 82.63 ‚ÇΩ

# 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É
{
    "final_rate": 82.63,
    "base_rate": 81.81,
    "best_source": "rapira",
    "markup_percent": 1.0
}
```

### 5. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã ‚úÖ

#### src/services/client_rates.py
- ‚úÖ `get_available_pairs()` - –ø–∞—Ä—ã –∏–∑ fx_source_pair
- ‚úÖ `get_client_rates(city)` - –∫—É—Ä—Å—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞
- ‚úÖ `format_rates_for_display(city)` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞
- ‚úÖ `get_rate_for_order(pair, city)` - –∫—É—Ä—Å –¥–ª—è –∑–∞—è–≤–∫–∏

#### src/services/best_rate.py
- ‚úÖ `get_best_city_rate()` - –ª—É—á—à–∏–π –∫—É—Ä—Å Rapira+Grinex + –Ω–∞—Ü–µ–Ω–∫–∞

#### src/services/rapira_simple.py
- ‚úÖ `get_base_rate()` - –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å –∏–∑ Rapira API
- ‚úÖ `get_city_rate()` - –∫—É—Ä—Å —Å –Ω–∞—Ü–µ–Ω–∫–æ–π (legacy, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### 6. –ê–¥–º–∏–Ω–∫–∞ ‚úÖ

#### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑–¥–µ–ª—ã
- ‚úÖ `/admin/city-rates` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
- ‚úÖ `/admin/fx/markup-rules` - –î–µ—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫
- ‚úÖ `/admin/orders` - –ó–∞—è–≤–∫–∏ (—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥–æ—Ä–æ–¥–µ)
- ‚úÖ `/admin/users` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- ‚úÖ `/admin/live-chats` - –ß–∞—Ç—ã
- ‚úÖ `/admin/faq` - FAQ

#### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã  
- ‚úÖ `/admin/fx/sources` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- ‚úÖ `/admin/fx/rates` - Raw –∫—É—Ä—Å—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
- ‚úÖ `/admin/fx/logs` - –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Grinex API 404
```
ERROR: Grinex API request failed: 404 Not Found
```
**–°—Ç–∞—Ç—É—Å:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ  
**–ü—Ä–∏—á–∏–Ω–∞:** API endpoint –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π  
**–†–µ—à–µ–Ω–∏–µ:** Rapira —Ä–∞–±–æ—Ç–∞–µ—Ç, —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. Grinex - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫.

### 2. Telegram Conflict
```
ERROR: Conflict: terminated by other getUpdates request
```
**–°—Ç–∞—Ç—É—Å:** –û–∂–∏–¥–∞–µ–º–æ  
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç  
**–†–µ—à–µ–Ω–∏–µ:** –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–¥.

### 3. Legacy tables
```
–¢–∞–±–ª–∏—Ü—ã trading_pairs –∏ rate_tiers –µ—â–µ –µ—Å—Ç—å –≤ –ë–î
```
**–°—Ç–∞—Ç—É—Å:** –ù–µ –º–µ—à–∞–µ—Ç  
**–ü—Ä–∏—á–∏–Ω–∞:** –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å  
**–†–µ—à–µ–Ω–∏–µ:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ–∑–∂–µ

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫—É—Ä—Å–æ–≤
- ‚úÖ Rapira API: —Ä–∞–±–æ—Ç–∞–µ—Ç (81.81 ‚ÇΩ)
- ‚ö†Ô∏è Grinex API: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- ‚úÖ 3 –ø–∞—Ä—ã: USDT/RUB, BTC/USDT, USD/RUB
- ‚úÖ –§–æ—Ä–º–∞—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (USDT/RUB)

### –ù–∞—Ü–µ–Ω–∫–∏
- ‚úÖ 7 –≥–æ—Ä–æ–¥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –§–æ—Ä–º—É–ª–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç: `base √ó (1 + percent/100) + fixed`
- ‚úÖ –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π flow
- ‚úÖ –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –∫—É—Ä—Å–æ–≤
- ‚úÖ –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏
- ‚úÖ –ö—É—Ä—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞
- ‚úÖ –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –ª—É—á—à–∏–π –∫—É—Ä—Å –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö

### –ê–¥–º–∏–Ω–∫–∞
- ‚úÖ City Rates —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Markup Rules —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ API endpoints –æ—Ç–≤–µ—á–∞—é—Ç
- ‚úÖ –ó–∞—è–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Ä–æ–¥–µ

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ end-to-end

### Test Case 1: –ö–ª–∏–µ–Ω—Ç –∏–∑ –†–æ—Å—Ç–æ–≤–∞ –ø–æ–∫—É–ø–∞–µ—Ç USDT

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ì–æ—Ä–æ–¥: –†–æ—Å—Ç–æ–≤ (+1%)
- –ü–∞—Ä–∞: USDT/RUB
- Operation: buy
- Rapira: 81.81 ‚ÇΩ
- Grinex: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å: 81.81 ‚ÇΩ (Rapira)
–ù–∞—Ü–µ–Ω–∫–∞: +1%
–§–∏–Ω–∞–ª—å–Ω—ã–π: 82.63 ‚ÇΩ
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç:**
```
üí∞ –í–∞—à –∫—É—Ä—Å: 82.63 ‚ÇΩ
‚îî –ë–∞–∑–æ–≤—ã–π: 81.81 ‚ÇΩ
‚îî –ù–∞—Ü–µ–Ω–∫–∞: +1%
‚îî –ò—Å—Ç–æ—á–Ω–∏–∫: RAPIRA
```

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∑–∞—è–≤–∫–µ:**
```json
{
  "city": "rostov",
  "city_name": "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
  "final_rate": 82.63,
  "base_rate": 81.81,
  "markup_percent": 1.0,
  "source": "rapira"
}
```

### Test Case 2: –ö–ª–∏–µ–Ω—Ç –∏–∑ –ú–æ—Å–∫–≤—ã —Å–º–æ—Ç—Ä–∏—Ç –∫—É—Ä—Å—ã

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ì–æ—Ä–æ–¥: –ú–æ—Å–∫–≤–∞ (0%)
- Rapira: 81.81 ‚ÇΩ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
USDT/RUB:
  –ü–æ–∫—É–ø–∫–∞: 81.81 ‚ÇΩ  (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)
  –ü—Ä–æ–¥–∞–∂–∞: 81.78 ‚ÇΩ  (–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)
  –ò—Å—Ç–æ—á–Ω–∏–∫: RAPIRA
```

### Test Case 3: –ê–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç –Ω–∞—Ü–µ–Ω–∫—É

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç /admin/city-rates
2. –ú–µ–Ω—è–µ—Ç –†–æ—Å—Ç–æ–≤ —Å 1% –Ω–∞ 1.2%
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í –ë–î: percent = 1.2
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –∏–∑ –†–æ—Å—Ç–æ–≤–∞ —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç: 82.79 ‚ÇΩ (–≤–º–µ—Å—Ç–æ 82.63 ‚ÇΩ)

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–∫–∏

### 1. –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã ‚úÖ
**–ë—ã–ª–æ:** –î–≤–µ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- `trading_pairs` (—Å—Ç–∞—Ä–∞—è)
- `fx_source_pair` (–Ω–æ–≤–∞—è)

**–°—Ç–∞–ª–æ:** –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
- `fx_source_pair` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
- –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é 006
- FSM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_pairs_for_fsm()` –∏–∑ fx_source_pair

### 2. –§–æ—Ä–º–∞—Ç –ø–∞—Ä ‚úÖ
**–ë—ã–ª–æ:** –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (USD_RUB vs USDT/RUB)

**–°—Ç–∞–ª–æ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- –í–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `USDT/RUB` (—Å —Å–ª—ç—à–µ–º)
- `source_symbol` –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –∏—Å—Ç–æ—á–Ω–∏–∫:
  - Rapira: `usdtrub` (lowercase, –±–µ–∑ —Å–ª—ç—à–∞)
  - Grinex: `USDTRUB` (uppercase, –±–µ–∑ —Å–ª—ç—à–∞)

### 3. –õ–æ–≥–∏–∫–∞ –∫—É—Ä—Å–æ–≤ ‚úÖ
**–ë—ã–ª–æ:** –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å VWAP, —Å–ø—Ä–µ–¥–∞–º–∏, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞–º–∏

**–°—Ç–∞–ª–æ:** –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞
```
Rapira + Grinex ‚Üí –õ—É—á—à–∏–π –±–∞–∑–æ–≤—ã–π ‚Üí –ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ ‚Üí –ö–ª–∏–µ–Ω—Ç
```

### 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É ‚úÖ
**–ë—ã–ª–æ:** –°—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞ rate_tiers, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã

**–°—Ç–∞–ª–æ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫—É—Ä—Å—ã
- –ü–æ–ª—É—á–∞—é—Ç—Å—è –≤ real-time –∏–∑ API
- –£—á–∏—Ç—ã–≤–∞—é—Ç –≥–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞
- –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –ª—É—á—à–∏–π –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞—Ü–µ–Ω–∫–∞

### 5. –°–µ—Ä–≤–∏—Å—ã ‚úÖ
**–°–æ–∑–¥–∞–Ω–æ 3 —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞:**
- `client_rates.py` - –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–∫—É—Ä—Å—ã –∏ –∑–∞—è–≤–∫–∏)
- `best_rate.py` - –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∫—É—Ä—Å–∞ + –Ω–∞—Ü–µ–Ω–∫–∞
- `rapira_simple.py` - –±–∞–∑–æ–≤—ã–µ –∫—É—Ä—Å—ã –∏–∑ Rapira

## üìã Checklist –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –î–∞–Ω–Ω—ã–µ
- [x] 2 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤ fx_source
- [x] 6 –ø–∞—Ä –≤ fx_source_pair (3 –ø–∞—Ä—ã √ó 2 –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
- [x] 8 –ø—Ä–∞–≤–∏–ª –Ω–∞—Ü–µ–Ω–∫–∏ (7 –≥–æ—Ä–æ–¥–æ–≤ + 1 –≥–ª–æ–±–∞–ª—å–Ω–æ–µ)
- [x] –ü–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

### –ö–æ–¥
- [x] FSM –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (ChooseCity state)
- [x] –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–æ—Ä–æ–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞
- [x] –ö—É—Ä—Å—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞
- [x] –ó–∞—è–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –≥–æ—Ä–æ–¥ –∏ –∫—É—Ä—Å
- [x] best_rate.py –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫
- [x] client_rates.py - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å

### –ê–¥–º–∏–Ω–∫–∞
- [x] City Rates —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Markup Rules —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Orders –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–æ—Ä–æ–¥
- [x] –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ Rapira —Ä–∞–∑–¥–µ–ª—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] CLIENT_FLOW_UPDATE.md
- [x] CITY_RATES_README.md
- [x] READY_TO_USE.md
- [x] –ò–¢–û–ì–û.md
- [x] –¢–ï–°–¢.md
- [x] FINAL_VERIFICATION.md

## üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç

### Web Admin
```
1. http://localhost:8000/admin/city-rates
   ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
   ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 7 –≥–æ—Ä–æ–¥–æ–≤
   ‚úÖ –ö—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
   ‚úÖ –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ü–µ–Ω–∫–∏
```

### Telegram Bot (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
```
1. –ù–∞–∂–º–∏—Ç–µ "üí± –ö—É—Ä—Å—ã"
   ‚úÖ –ü–æ—è–≤–ª—è—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –≥–æ—Ä–æ–¥–æ–≤
   
2. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
   ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
   
3. –ù–∞–∂–º–∏—Ç–µ "‚úâÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
   ‚úÖ –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
   ‚úÖ –í—ã–±–æ—Ä –ø–∞—Ä—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—É—Ä—Å
```

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Grinex API URL (—Å–µ–π—á–∞—Å 404)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–∞—Ä (ETH/RUB, EUR/USDT –∏ —Ç.–¥.)
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–æ–≥–¥–∞ –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤ Redis
- [ ] WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] –ì—Ä–∞—Ñ–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
- [ ] –ê–ª–µ—Ä—Ç—ã –∞–¥–º–∏–Ω—É –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∫—É—Ä—Å–∞

## ‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞

### –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- ‚úÖ –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Rapira API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ì–æ—Ä–æ–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π flow —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ê–¥–º–∏–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞

### –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
- ‚ö†Ô∏è Grinex –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Rapira)
- ‚ö†Ô∏è Telegram bot conflict (–Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è dev)

### –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –¥–ª—è
- ‚úÖ Web Admin –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ü–µ–Ω–æ–∫

---

## üéâ –ò—Ç–æ–≥–æ

**–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**

‚úÖ **–ë–∞–∑–æ–≤—ã–µ –∫—É—Ä—Å—ã** - Rapira + Grinex (fallback –Ω–∞ Rapira)  
‚úÖ **–¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ fx_source_pair  
‚úÖ **–ù–∞—Ü–µ–Ω–∫–∏** - —Ñ–∏–∫—Å/–ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º  
‚úÖ **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ–∫–∞–∑** - –∫—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞  
‚úÖ **–ó–∞—è–≤–∫–∏** - —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é  
‚úÖ **–ê–¥–º–∏–Ω–∫–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏  

**–õ–æ–≥–∏–∫–∞:**
```
Rapira/Grinex API
      ‚Üì
–õ—É—á—à–∏–π –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å
      ‚Üì
–ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ (—Ñ–∏–∫—Å/–ø—Ä–æ—Ü–µ–Ω—Ç)
      ‚Üì
–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –∫–ª–∏–µ–Ω—Ç—É
```

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ

