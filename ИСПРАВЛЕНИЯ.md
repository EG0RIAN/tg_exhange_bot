# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–æ–∫

## üîß –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –¢–∞–±–ª–∏—Ü–∞ `trading_pairs` (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)
- –¢–∞–±–ª–∏—Ü–∞ `fx_source_pair` (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
- –ù–µ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π
- –†–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: `USD_RUB` vs `USDT/RUB`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `006_sync_trading_pairs.sql`
- ‚úÖ –ü–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –§–æ—Ä–º–∞—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: `USDT/RUB` (—Å —Å–ª—ç—à–µ–º)
- ‚úÖ `get_pairs_for_fsm()` —Ç–µ–ø–µ—Ä—å –±–µ—Ä–µ—Ç –∏–∑ `fx_source_pair`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```sql
internal_symbol | sources
USDT/RUB       | 2 (rapira + grinex)
BTC/USDT       | 2 (rapira + grinex)
USD/RUB        | 2 (rapira + grinex)
```

---

### 2. ‚ùå –ù–µ—Ç –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º flow

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–≥ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥
- –ö—É—Ä—Å—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –±–µ–∑ —É—á–µ—Ç–∞ –≥–æ—Ä–æ–¥–∞
- –ó–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥–æ—Ä–æ–¥–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `ChooseCity` –≤ FSM
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `get_cities_keyboard()`
- ‚úÖ –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ - –ø–µ—Ä–≤—ã–π —à–∞–≥ –≤ "üí± –ö—É—Ä—Å—ã" –∏ "‚úâÔ∏è –ó–∞—è–≤–∫–∞"
- ‚úÖ –ö—É—Ä—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –Ω–∞—Ü–µ–Ω–∫–∏ –≥–æ—Ä–æ–¥–∞
- ‚úÖ –ì–æ—Ä–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `rate_snapshot`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ö–ª–∏–µ–Ω—Ç ‚Üí –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ ‚Üí –ö—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π –≥–æ—Ä–æ–¥–∞
```

---

### 3. ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ "–ª—É—á—à–∏–π –∫—É—Ä—Å"

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫
- –ù–µ –±—ã–ª–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è Rapira vs Grinex
- –ù–µ –≤—ã–±–∏—Ä–∞–ª—Å—è –ª—É—á—à–∏–π –∫—É—Ä—Å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å `best_rate.py`
- ‚úÖ –õ–æ–≥–∏–∫–∞: –¥–ª—è buy - min(rapira, grinex), –¥–ª—è sell - max()
- ‚úÖ Fallback –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—ã–±—Ä–∞–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
rapira = 81.81 ‚ÇΩ
grinex = 81.90 ‚ÇΩ
‚Üí –î–ª—è buy: –∏—Å–ø–æ–ª—å–∑—É–µ–º 81.81 ‚ÇΩ (Rapira –ª—É—á—à–µ)
```

---

### 4. ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ main.py

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–¥ FX endpoints –±—ã–ª –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω
- –°—Ç–∞—Ä—ã–µ Rapira routes –Ω–µ —É–¥–∞–ª–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å—Ç–∞—Ä—ã–µ Rapira routes (~490 —Å—Ç—Ä–æ–∫)
- ‚úÖ –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ FX endpoints
- ‚úÖ –§–∞–π–ª –æ—á–∏—â–µ–Ω –æ—Ç –º—É—Å–æ—Ä–∞
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ API

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
main.py: 1409 —Å—Ç—Ä–æ–∫ (–±—ã–ª–æ ~1900)
–£–¥–∞–ª–µ–Ω–æ ~500 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ/—Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞
```

---

### 5. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ Rapira API

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `lowestPrice` —Å–æ–¥–µ—Ä–∂–∞–ª placeholder (99999)
- –†–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –±—ã–ª–∞ –≤ `items[0].price`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ `items[0]`, –ø–æ—Ç–æ–º `lowestPrice`
- ‚úÖ –§–∏–ª—å—Ç—Ä placeholder –∑–Ω–∞—á–µ–Ω–∏–π (> 90000)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π best_ask: 81.81 ‚ÇΩ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
// –ë—ã–ª–æ
{
  "best_ask": 99999.0
}

// –°—Ç–∞–ª–æ  
{
  "best_ask": 81.81
}
```

---

### 6. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö—É—Ä—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –±—Ä–∞–ª–∏—Å—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç
- –ù–µ –±—ã–ª–æ –µ–¥–∏–Ω–æ–π –ª–æ–≥–∏–∫–∏
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω `client_rates.py` - –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- ‚úÖ `get_client_rates(city)` - –≤—Å–µ –∫—É—Ä—Å—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞
- ‚úÖ `get_rate_for_order()` - –∫—É—Ä—Å –¥–ª—è –∑–∞—è–≤–∫–∏
- ‚úÖ `format_rates_for_display()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
# –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
from src.services.client_rates import get_rate_for_order

rate = await get_rate_for_order("USDT/RUB", "rostov", "buy")
# –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫—É—Ä—Å —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
```

---

### 7. ‚ùå –ù–µ–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ rate_snapshot

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ—Ö—Ä–∞–Ω—è–ª—Å—è —Ç–æ–ª—å–∫–æ –∫—É—Ä—Å
- –ù–µ –±—ã–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞–∑–æ–≤–æ–º –∫—É—Ä—Å–µ
- –ù–µ –±—ã–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ –∏ –Ω–∞—Ü–µ–Ω–∫–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω rate_snapshot
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: –≥–æ—Ä–æ–¥, final_rate, base_rate, markup, source, timestamp

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "city": "rostov",
  "city_name": "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
  "pair": "USDT/RUB",
  "final_rate": 82.63,
  "base_rate": 81.81,
  "markup_percent": 1.0,
  "source": "rapira",
  "timestamp": "2025-10-14T02:58:00"
}
```

---

### 8. ‚ùå URL encoding –≤ API

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∏–º–≤–æ–ª `USDT/RUB` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ path
- FastAPI –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª –º–∞—Ä—à—Ä—É—Ç—ã (404)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- ‚úÖ `GET /api/city-rates/all?symbol=USDT/RUB`
- ‚úÖ JavaScript –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `encodeURIComponent()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```javascript
// –ë—ã–ª–æ
fetch(`/api/city-rates/all/${symbol}`)  // 404!

// –°—Ç–∞–ª–æ
fetch(`/api/city-rates/all?symbol=${encodeURIComponent(symbol)}`)  // ‚úÖ
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤
- `migrations/006_sync_trading_pairs.sql` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞—Ä
- `src/services/client_rates.py` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å
- `src/services/best_rate.py` - –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∫—É—Ä—Å–∞
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤
- `src/fsm.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ ChooseCity
- `src/keyboards.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–æ—Ä–æ–¥–æ–≤
- `src/handlers/fsm_request.py` - –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞, –ø–æ–∫–∞–∑ –∫—É—Ä—Å–∞
- `src/handlers/menu.py` - –∫—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º
- `src/services/content.py` - get_pairs_for_fsm –∏–∑ fx_source_pair
- `src/web_admin/main.py` - –æ—á–∏—â–µ–Ω –æ—Ç –¥—É–±–ª–µ–π
- `templates/city_rates.html` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω JavaScript

### –£–¥–∞–ª–µ–Ω–æ
- `src/handlers/admin_rapira.py` - –≤–µ—Å—å —Ñ–∞–π–ª
- ~870 —Å—Ç—Ä–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ Rapira –∫–æ–¥–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ endpoints

## ‚úÖ –ò—Ç–æ–≥–æ

### –í—Å–µ –Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. ‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
2. ‚úÖ –§–æ—Ä–º–∞—Ç—ã —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã  
3. ‚úÖ –õ–æ–≥–∏–∫–∞ —É–ø—Ä–æ—â–µ–Ω–∞
4. ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π flow –æ–±–Ω–æ–≤–ª–µ–Ω
5. ‚úÖ –ö–æ–¥ –æ—á–∏—â–µ–Ω –æ—Ç –¥—É–±–ª–µ–π
6. ‚úÖ API endpoints –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
7. ‚úÖ rate_snapshot –ø–æ–ª–Ω—ã–π
8. ‚úÖ URL encoding –∏—Å–ø—Ä–∞–≤–ª–µ–Ω

### –ü—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

**–õ–æ–≥–∏–∫–∞:**
```
Rapira + Grinex
      ‚Üì
–õ—É—á—à–∏–π –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å
      ‚Üì
–ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ (—Ñ–∏–∫—Å/–ø—Ä–æ—Ü–µ–Ω—Ç)
      ‚Üì
–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –∫–ª–∏–µ–Ω—Ç—É
```

**–ü–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:**
```
fx_source_pair ‚Üê –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
      ‚Üì
get_pairs_for_fsm() ‚Üí –∫–ª–∏–µ–Ω—Ç–∞–º
      ‚Üì
best_rate.py ‚Üí –∫—É—Ä—Å —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
```

**–í—Å—ë –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!** ‚úÖ

