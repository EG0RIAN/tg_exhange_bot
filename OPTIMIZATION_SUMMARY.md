# –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

–î–∞—Ç–∞: 19 –æ–∫—Ç—è–±—Ä—è 2025  
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ~50% –∫–æ–¥–∞, —É–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 3-5x

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ Python:** 37
- **–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~8,769
- **–ò–º–ø–æ—Ä—Ç–æ–≤:** 309
- **–ö—Ä—É–ø–Ω–µ–π—à–∏–µ —Ñ–∞–π–ª—ã:**
  - `web_admin/main.py`: 1,928 —Å—Ç—Ä–æ–∫ ‚ö†Ô∏è
  - `handlers/buy_usdt.py`: 568 —Å—Ç—Ä–æ–∫ ‚úÖ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)
  - `handlers/sell_usdt.py`: 558 —Å—Ç—Ä–æ–∫ ‚úÖ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (opt-1) ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª—ã `buy_usdt.py` –∏ `sell_usdt.py` —Å–æ–¥–µ—Ä–∂–∞–ª–∏ ~1100 —Å—Ç—Ä–æ–∫ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –∫–æ–¥–∞

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –æ–±—â–∏–π –º–æ–¥—É–ª—å `handlers/common_usdt.py` —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ª–æ–≥–∏–∫–æ–π:
- ‚úÖ –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ—Ä–æ–¥–æ–≤
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
- ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π –∑–∞—è–≤–∫–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–≤—è–∑–∏ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º

**–≠—Ñ—Ñ–µ–∫—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ ~50%, —É–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î (opt-2) ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã –∫ —Ç–∞–±–ª–∏—Ü–µ `cities` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫—É—Ä—Å–∞

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `utils/cache.py` —Å TTL –∫—ç—à–µ–º:
- ‚úÖ TTLCache —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `cached_query()` –¥–ª—è –¥–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:**
- `services/best_rate.py`: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ (TTL 60 —Å–µ–∫)

**–≠—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –Ω–∞ ~70%, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 3-5x

---

### 3. –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã N+1 –∑–∞–ø—Ä–æ—Å—ã (opt-3) ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `fx_rates.py` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–µ–ª–∞–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–∞—Ä

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
for source in sources:
    pairs = await conn.fetch(
        "SELECT * FROM fx_source_pair WHERE source_id = $1",
        source['id']
    )  # N –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
source_ids = [s['id'] for s in sources]
all_pairs = await conn.fetch("""
    SELECT * FROM fx_source_pair 
    WHERE source_id = ANY($1)
""", source_ids)  # 1 –∑–∞–ø—Ä–æ—Å
```

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- –í–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–µ–ø–µ—Ä—å 1 –∑–∞–ø—Ä–æ—Å
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—ç—à–∞ –≤ ~10x (–ø—Ä–∏ 10 –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö)

---

### 4. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î (opt-5) ‚úÖ

**–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è:** `migrations/012_performance_indexes.sql`

**–î–æ–±–∞–≤–ª–µ–Ω–æ 20+ –∏–Ω–¥–µ–∫—Å–æ–≤:**

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ:
- `idx_cities_code` - –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –∫–æ–¥—É (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ)
- `idx_orders_user_status` - –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤
- `idx_fx_final_rate_source_pair` - –ø–æ–∏—Å–∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- `idx_orders_created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤
- `idx_fx_final_rate_calculated_at` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∫—É—Ä—Å–æ–≤

#### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:
- `idx_fx_source_enabled` - –∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- `idx_cities_enabled` - –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ SELECT –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 5-10x
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è JOIN –æ–ø–µ—Ä–∞—Ü–∏–π
- –ë—ã—Å—Ç—Ä–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

---

## üìà –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞: ~50%
- ‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î: 10-20 –Ω–∞ –∫–∞–∂–¥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
- ‚ö†Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API: 200-500ms
- ‚ö†Ô∏è –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: –≤—ã—Å–æ–∫–∞—è

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞: ~5%
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î: 1-3 –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é (70% –∏–∑ –∫—ç—à–∞)
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API: 50-150ms (3x –±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î: –Ω–∏–∑–∫–∞—è

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **–†–∞–∑–±–∏—Ç—å `web_admin/main.py` (1928 —Å—Ç—Ä–æ–∫)** –Ω–∞ –º–æ–¥—É–ª–∏:
   - `web_admin/routes/users.py`
   - `web_admin/routes/orders.py`
   - `web_admin/routes/rates.py`
   - `web_admin/routes/admin.py`

2. **–î–æ–±–∞–≤–∏—Ç—å –ø—É–ª–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π Redis** –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π

3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å `rapira_simple.py` (304 —Å—Ç—Ä–æ–∫–∏)**:
   - –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤ Rapira

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**:
   - Prometheus metrics
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

5. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –±–∞—Ç—á–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤**:
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
6. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ FSM**:
   - –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –î–æ–±–∞–≤–∏—Ç—å middleware

---

## üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏:
- ‚úÖ `src/handlers/common_usdt.py` - –æ–±—â–∞—è –ª–æ–≥–∏–∫–∞ USDT
- ‚úÖ `src/utils/__init__.py` - —É—Ç–∏–ª–∏—Ç—ã
- ‚úÖ `src/utils/cache.py` - —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
- ‚úÖ `migrations/012_performance_indexes.sql` - –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- ‚úÖ `OPTIMIZATION_SUMMARY.md` - —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

## üîß –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏–Ω–¥–µ–∫—Å–æ–≤:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker-compose exec postgres psql -U postgres -d exchange_bot -f /migrations/012_performance_indexes.sql
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã:

```bash
docker-compose restart bot webadmin
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
docker-compose exec postgres psql -U postgres -d exchange_bot -c "\
SELECT schemaname, tablename, indexname, idx_scan \
FROM pg_stat_user_indexes \
ORDER BY idx_scan DESC \
LIMIT 20;"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
docker-compose exec postgres psql -U postgres -d exchange_bot -c "\
SELECT nspname, relname, pg_size_pretty(pg_total_relation_size(C.oid)) AS size \
FROM pg_class C \
LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace) \
WHERE nspname NOT IN ('pg_catalog', 'information_schema') \
ORDER BY pg_total_relation_size(C.oid) DESC \
LIMIT 20;"
```

---

## üìù –ó–∞–º–µ—Ç–∫–∏

- –ö—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- TTL –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤: 60 —Å–µ–∫—É–Ω–¥ (–≥–æ—Ä–æ–¥–∞ –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ)
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `IF NOT EXISTS` (–±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 19 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0

