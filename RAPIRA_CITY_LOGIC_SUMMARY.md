# Rapira City Logic - ะัะพะณะพะฒะพะต ัะตะทัะผะต

## ๐ฏ ะะตะฐะปะธะทะพะฒะฐะฝะฝะฐั ะปะพะณะธะบะฐ

### ะะพะฝัะตะฟัะธั
```
ะะดะธะฝ ะฟะฐััะตั Rapira โ ะะฐะทะพะฒัะน ะบััั (ะะพัะบะฒะฐ) โ ะะฐัะตะฝะบะธ ะฟะพ ะณะพัะพะดะฐะผ โ ะะพัะพะฒะพ!
```

### ะคะพัะผัะปะฐ
```
final_rate = base_rate * (1 + markup_percent/100)
```

**ะัะธะผะตั:**
- ะะฐะทะพะฒัะน ะบััั (ะะพัะบะฒะฐ): 81.83 โฝ
- ะะพััะพะฒ (+1%): 81.83 ร 1.01 = **82.65 โฝ**
- ะะธะถะฝะธะน ะะพะฒะณะพัะพะด (+0.8%): 81.83 ร 1.008 = **82.48 โฝ**

## โ ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ

### 1. Backend (`src/services/rapira_simple.py`)
- โ ะฃะฟัะพัะตะฝะฝัะน ะบะปะธะตะฝั Rapira
- โ ะคัะฝะบัะธั `get_base_rate(symbol)` - ะฟะพะปััะตะฝะธะต ะฑะฐะทะพะฒะพะณะพ ะบัััะฐ
- โ ะคัะฝะบัะธั `get_city_rate(symbol, city, operation)` - ะบััั ั ะฝะฐัะตะฝะบะพะน
- โ ะะพะดะดะตัะถะบะฐ buy/sell ะพะฟะตัะฐัะธะน
- โ ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟัะธะผะตะฝะตะฝะธะต ะฝะฐัะตะฝะพะบ ะธะท ะะ

### 2. Database (`migrations/005_city_markups.sql`)
- โ 7 ะฟัะฐะฒะธะป ะฝะฐัะตะฝะบะธ ะดะปั ะณะพัะพะดะพะฒ:
  - ะะพัะบะฒะฐ: 0% (ะฑะฐะทะพะฒัะน)
  - ะกะะฑ: +0.3%
  - ะะบะฐัะตัะธะฝะฑััะณ: +0.7%
  - ะะธะถะฝะธะน ะะพะฒะณะพัะพะด: +0.8%
  - ะะฐะทะฐะฝั: +0.9%
  - ะะพััะพะฒ: +1%
  - ะััะณะธะต: +1.5%

### 3. Web Admin API (`src/web_admin/main.py`)
- โ `GET /admin/city-rates` - ัััะฐะฝะธัะฐ ัะฟัะฐะฒะปะตะฝะธั
- โ `GET /api/city-rate/{city}/{symbol}` - ะบััั ะดะปั ะณะพัะพะดะฐ
- โ `GET /api/city-rates/all/{symbol}` - ะบัััั ะฒัะตั ะณะพัะพะดะพะฒ
- โ `POST /api/city-rates/update-markup` - ะธะทะผะตะฝะธัั ะฝะฐัะตะฝะบั
- โ `GET /api/rapira/base-rate/{symbol}` - ะฑะฐะทะพะฒัะน ะบััั Rapira

### 4. Web UI (`templates/city_rates.html`)
- โ ะขะฐะฑะปะธัะฐ ะฝะฐัััะพะนะบะธ ะฝะฐัะตะฝะพะบ ะฟะพ ะณะพัะพะดะฐะผ
- โ ะะฐััะพัะบะธ ั ะบัััะฐะผะธ ะดะปั ะบะฐะถะดะพะณะพ ะณะพัะพะดะฐ
- โ ะะฐะทะพะฒัะน ะบััั ะธะท Rapira (Ask/Bid/Spread)
- โ ะะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะฝะฐัะตะฝะพะบ ะฒ ะผะพะดะฐะปัะฝะพะผ ะพะบะฝะต
- โ Real-time ะพะฑะฝะพะฒะปะตะฝะธะต
- โ ะัะฑะพั ะฟะฐัั (USDT/RUB, BTC/USDT ะธ ั.ะด.)

### 5. Dashboard Integration
- โ ะะพะฒะฐั ะบะฐััะพัะบะฐ "๐ ะัััั ะฟะพ ะณะพัะพะดะฐะผ" (ะทะตะปะตะฝัะน ะณัะฐะดะธะตะฝั)
- โ 4 ะบะฐััะพัะบะธ ะธะฝัะตะณัะฐัะธะน ะฒะผะตััะพ 3

### 6. Documentation
- โ `CITY_RATES_README.md` - ะฟะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ
- โ `CITY_RATES_QUICKSTART.md` - ะฑัััััะน ััะฐัั
- โ `RAPIRA_CITY_LOGIC_SUMMARY.md` - ััะพ ัะตะทัะผะต

## ๐ ะะธะทัะฐะปัะฝะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Rapira API                            โ
โ        https://api.rapira.net/market/exchange-plate-mini โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
           โโโโโโโโโโโโโโโโโโโโโโโ
           โ  ะะฐะทะพะฒัะน ะบััั       โ
           โ  (ะะพัะบะฒะฐ)           โ
           โ  81.83 โฝ            โ
           โโโโโโโโโโโโฌโโโโโโโโโโโ
                      โ
      โโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโ
      โ               โ               โ
      โผ               โผ               โผ
โโโโโโโโโโโโ   โโโโโโโโโโโโ   โโโโโโโโโโโโ
โ ะะพัะบะฒะฐ   โ   โ ะะพััะพะฒ   โ   โ ะ.ะะพะฒะณ.  โ
โ  0%      โ   โ  +1%     โ   โ  +0.8%   โ
โ 81.83 โฝ  โ   โ 82.65 โฝ  โ   โ 82.48 โฝ  โ
โโโโโโโโโโโโ   โโโโโโโโโโโโ   โโโโโโโโโโโโ
```

## ๐ง ะะฐัััะพะนะบะฐ ะณะพัะพะดะพะฒ

### ะงะตัะตะท Web Admin
1. http://localhost:8000/admin/city-rates
2. ะะฝะพะฟะบะฐ "ะะทะผะตะฝะธัั" ะฝะฐะฟัะพัะธะฒ ะณะพัะพะดะฐ
3. ะะฒะตััะธ ะฝะพะฒัั ะฝะฐัะตะฝะบั (ะฝะฐะฟัะธะผะตั: 1.2)
4. ะกะพััะฐะฝะธัั

### ะงะตัะตะท SQL
```sql
-- ะะพััะพะฒ ัะตะฟะตัั +1.2%
UPDATE fx_markup_rule
SET percent = 1.2
WHERE description ILIKE '%ะณะพัะพะด: rostov%';

-- ะะบะฐัะตัะธะฝะฑััะณ ัะตะฟะตัั +0.5%
UPDATE fx_markup_rule
SET percent = 0.5
WHERE description ILIKE '%ะณะพัะพะด: ekaterinburg%';
```

### ะงะตัะตะท API
```bash
curl -X POST http://localhost:8000/api/city-rates/update-markup \
  -d "city=rostov&percent=1.2"
```

## ๐ ะะพะฑะฐะฒะธัั ะฝะพะฒัะน ะณะพัะพะด

### 1. SQL ะผะธะณัะฐัะธั
```sql
INSERT INTO fx_markup_rule (level, percent, fixed, enabled, description, rounding_mode, round_to)
VALUES ('global', 1.1, 0, true, 'ะะฐัะตะฝะบะฐ ะดะปั ะณะพัะพะดะฐ: sochi (ะกะพัะธ)', 'ROUND_HALF_UP', 2);
```

### 2. ะะฑะฝะพะฒะธัั ะบะพะด (ะพะฟัะธะพะฝะฐะปัะฝะพ)
ะ `src/services/rapira_simple.py`:
```python
CITIES = {
    'moscow': 'ะะพัะบะฒะฐ',
    'rostov': 'ะะพััะพะฒ-ะฝะฐ-ะะพะฝั',
    'nizhniy_novgorod': 'ะะธะถะฝะธะน ะะพะฒะณะพัะพะด',
    'spb': 'ะกะฐะฝะบั-ะะตัะตัะฑััะณ',
    'ekaterinburg': 'ะะบะฐัะตัะธะฝะฑััะณ',
    'kazan': 'ะะฐะทะฐะฝั',
    'sochi': 'ะกะพัะธ',  # <-- ะะพะฒัะน ะณะพัะพะด
    'other': 'ะััะณะธะต ะณะพัะพะดะฐ'
}
```

## ๐ API Endpoints

| Endpoint | ะะตัะพะด | ะะฟะธัะฐะฝะธะต |
|----------|-------|----------|
| `/admin/city-rates` | GET | Web ัััะฐะฝะธัะฐ ัะฟัะฐะฒะปะตะฝะธั |
| `/api/city-rate/{city}/{symbol}` | GET | ะััั ะดะปั ะณะพัะพะดะฐ |
| `/api/city-rates/all/{symbol}` | GET | ะัััั ะฒัะตั ะณะพัะพะดะพะฒ |
| `/api/city-rates/update-markup` | POST | ะะทะผะตะฝะธัั ะฝะฐัะตะฝะบั |
| `/api/rapira/base-rate/{symbol}` | GET | ะะฐะทะพะฒัะน ะบััั Rapira |

## ๐ก ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะ ะฑะพัะต (ะฟะพะปััะธัั ะบััั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั)

```python
from src.services.rapira_simple import get_city_rate

# ะะท ะฟัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั
user_city = user_profile['city']  # 'rostov'

# ะะพะปััะฐะตะผ ะบััั
rate = await get_city_rate("USDT/RUB", user_city, "buy")

await message.answer(
    f"๐ฐ ะะฐั ะบััั ะฒ ะณะพัะพะดะต {rate['city']}:\n"
    f"**{rate['final_rate']:.2f} โฝ** ะทะฐ 1 USDT\n\n"
    f"_ะะฐะทะพะฒัะน ะบััั: {rate['base_rate']:.2f} โฝ_\n"
    f"_ะะฐัะตะฝะบะฐ ะณะพัะพะดะฐ: +{rate['markup_percent']}%_"
)
```

### ะ ะฐะดะผะธะฝะบะต (ะฟะพะบะฐะทะฐัั ะฒัะต ะบัััั)

```python
from src.services.rapira_simple import CITIES

cities_data = {}
for city_code in CITIES.keys():
    rate = await get_city_rate("USDT/RUB", city_code, "buy")
    cities_data[city_code] = rate

# ะัะพะฑัะฐะทะธัั ะฒ ัะฐะฑะปะธัะต/ะบะฐััะพัะบะฐั
```

## ๐ ะะฝัะตะณัะฐัะธั ั ัััะตััะฒัััะธะผะธ ัะธััะตะผะฐะผะธ

### ะกะพะฒะผะตััะธะผะพััั ั FX Rates
- โ ะัะฟะพะปัะทัะตั ัััะตััะฒััััั ัะฐะฑะปะธัั `fx_markup_rule`
- โ ะะฐะฑะพัะฐะตั ะฟะฐัะฐะปะปะตะปัะฝะพ ั Grinex/ะดััะณะธะผะธ ะธััะพัะฝะธะบะฐะผะธ
- โ ะขะต ะถะต ะฟัะธะฝัะธะฟั ะฟัะธะพัะธัะตัะฐ ะฟัะฐะฒะธะป
- โ ะขะฐ ะถะต ัะพัะผัะปะฐ ะฝะฐัะตะฝะบะธ

### ะะต ะบะพะฝัะปะธะบััะตั ั:
- โ FX Sources (Grinex, Rapira ะบะฐะบ ะธััะพัะฝะธะบ)
- โ FX Markup Rules (ะพะฑัะธะต ะฟัะฐะฒะธะปะฐ)
- โ ะกัะฐัะพะน ะปะพะณะธะบะพะน Rapira (ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะพะฑะต)

## ๐ ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะน ะปะพะณะธะบะธ

| ะัะฟะตะบั | ะกัะฐัะฐั ะปะพะณะธะบะฐ | ะะพะฒะฐั ะปะพะณะธะบะฐ |
|--------|---------------|--------------|
| ะกะปะพะถะฝะพััั | ะััะพะบะฐั (VWAP, ัะฟัะตะดั, ะบะพััะตะบัะธัะพะฒะบะธ) | ะะธะทะบะฐั (ะฑะฐะทะพะฒัะน + ะฝะฐัะตะฝะบะฐ) |
| ะะฐัััะพะนะบะฐ | ะะฝะพะณะพ ะฟะฐัะฐะผะตััะพะฒ | ะะดะธะฝ ะฟัะพัะตะฝั ะฝะฐ ะณะพัะพะด |
| ะัะพะทัะฐัะฝะพััั | ะกะปะพะถะฝะพ ะพะฑัััะฝะธัั ะบะปะธะตะฝัั | ะะพะฝััะฝะพ: ะะพัะบะฒะฐ + ะฝะฐัะตะฝะบะฐ |
| ะะธะฑะบะพััั | ะะณัะฐะฝะธัะตะฝะฝะฐั | ะัะฑะฐั ะฝะฐัะตะฝะบะฐ ะปัะฑะพะผั ะณะพัะพะดั |
| ะฃะฟัะฐะฒะปะตะฝะธะต | ะงะตัะตะท ะบะพะด/ENV | ะงะตัะตะท ะฐะดะผะธะฝะบั ะฒ 1 ะบะปะธะบ |

## โ ะงะตะบะปะธัั ะทะฐะฟััะบะฐ

- [x] ะะธะณัะฐัะธั ัะพะทะดะฐะฝะฐ (`005_city_markups.sql`)
- [x] ะะปะธะตะฝั Rapira ัะฟัะพัะตะฝ (`rapira_simple.py`)
- [x] API endpoints ะดะพะฑะฐะฒะปะตะฝั (`main.py`)
- [x] Web UI ัะพะทะดะฐะฝ (`city_rates.html`)
- [x] Dashboard ะพะฑะฝะพะฒะปะตะฝ (ะฝะพะฒะฐั ะบะฐััะพัะบะฐ)
- [x] ะะพะบัะผะตะฝัะฐัะธั ะฝะฐะฟะธัะฐะฝะฐ
- [ ] ะะธะณัะฐัะธั ะฟัะธะผะตะฝะตะฝะฐ
- [ ] Webadmin ะฟะตัะตะทะฐะฟััะตะฝ
- [ ] ะัะพัะตััะธัะพะฒะฐะฝะพ ะฒ ะฑัะฐัะทะตัะต

## ๐ ะกะปะตะดัััะธะต ัะฐะณะธ

```bash
# 1. ะัะธะผะตะฝะธัั ะผะธะณัะฐัะธั
docker-compose exec postgres psql -U exchange -d exchange -f /app/migrations/005_city_markups.sql

# 2. ะะตัะตะทะฐะฟัััะธัั
docker-compose restart webadmin

# 3. ะัะบัััั
http://localhost:8000/admin/city-rates

# 4. ะัะพะฒะตัะธัั API
curl "http://localhost:8000/api/rapira/base-rate/USDT%2FRUB"
curl "http://localhost:8000/api/city-rates/all/USDT%2FRUB?operation=buy"
```

---

**ะะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!** ๐

ะัะพััะฐั, ะฟะพะฝััะฝะฐั ะปะพะณะธะบะฐ: **Rapira ะฑะฐะทะพะฒัะน ะบััั + ะฝะฐัะตะฝะบะฐ ะณะพัะพะดะฐ = ัะธะฝะฐะปัะฝัะน ะบััั ะดะปั ะบะปะธะตะฝัะฐ**

