# FX Rates System - Implementation Summary

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞–ª—é—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –±–∏—Ä–∂ Grinex –∏ Rapira, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≥–∏–±–∫–∏—Ö –Ω–∞—Ü–µ–Ω–æ–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–µ–±-–∞–¥–º–∏–Ω–∫—É.

### üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `migrations/004_fx_rates_system.sql` - –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î
- ‚úÖ 7 —Ç–∞–±–ª–∏—Ü: sources, pairs, raw_rates, markup_rules, final_rates, sync_logs, snapshots
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ updated_at
- ‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Grinex, Rapira, –ø—Ä–∏–º–µ—Ä—ã –ø–∞—Ä)

#### 2. API –ö–ª–∏–µ–Ω—Ç—ã
- ‚úÖ `src/services/grinex.py` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è Grinex Exchange
  - –ü—É–±–ª–∏—á–Ω—ã–π REST API
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–∫–µ—Ä–æ–≤ (–µ–¥–∏–Ω–∏—á–Ω—ã—Ö –∏ bulk)
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
  - Health monitoring
  - Retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø–∞—É–∑–æ–π
  
- ‚úÖ `src/services/rapira.py` - —É–ª—É—á—à–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ plate-mini –∏ rates —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

#### 3. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- ‚úÖ `src/services/fx_rates.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
  - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–æ–∫ (–ø—Ä–æ—Ü–µ–Ω—Ç + —Ñ–∏–∫—Å)
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (pair > source > global)
  - 4 —Ä–µ–∂–∏–º–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (ROUND_HALF_UP, DOWN, UP, BANKERS)
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (sources, pairs, rules)
  - Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
  - Stale detection

#### 4. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
- ‚úÖ `src/services/fx_scheduler.py` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  - –†—É—á–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  - –°—Ç–∞—Ç—É—Å –∏ –º–µ—Ç—Ä–∏–∫–∏

#### 5. –í–µ–±-–∞–¥–º–∏–Ω–∫–∞
- ‚úÖ `src/web_admin/main.py` - API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
  - CRUD –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - CRUD –ø—Ä–∞–≤–∏–ª –Ω–∞—Ü–µ–Ω–∫–∏
  - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∫—É—Ä—Å–æ–≤
  - –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  - REST API –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
  
- ‚úÖ HTML —à–∞–±–ª–æ–Ω—ã:
  - `fx_sources.html` - —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - `fx_source_pairs.html` - –ø–∞—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  - `fx_markup_rules.html` - –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Ü–µ–Ω–∫–∏
  - `fx_markup_rule_form.html` - —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
  - `fx_rates.html` - —Ç–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã
  - `fx_sync_logs.html` - –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ `src/bot.py` - –∑–∞–ø—É—Å–∫ FX –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
- ‚úÖ Graceful shutdown –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

#### 7. –¢–µ—Å—Ç—ã
- ‚úÖ `tests/test_fx_rates.py`
  - –¢–µ—Å—Ç—ã –Ω–∞—Ü–µ–Ω–æ–∫ (–ø—Ä–æ—Ü–µ–Ω—Ç, —Ñ–∏–∫—Å, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
  - –¢–µ—Å—Ç—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª
  - –¢–µ—Å—Ç—ã –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
  - –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
  - 15+ —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤

#### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `FX_RATES_README.md` - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- ‚úÖ `fx_env_example.txt` - –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –≠—Ç–æ—Ç —Ñ–∞–π–ª - summary —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ postgres
docker-compose exec postgres psql -U exchange -d exchange < /app/migrations/004_fx_rates_system.sql
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ `fx_env_example.txt` –≤ –≤–∞—à `.env`:

```bash
# FX Settings
FX_UPDATE_INTERVAL_SECONDS=60
FX_STALE_CHECK_INTERVAL=300
FX_STALE_THRESHOLD_SECONDS=180

# Grinex API
GRINEX_API_BASE=https://api.grinex.io
GRINEX_TIMEOUT=5
GRINEX_MAX_RETRIES=3
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

```bash
docker-compose restart bot webadmin
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É: http://localhost:8000/admin/fx/sources

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   FX Rates System                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                ‚îÇ                ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Grinex ‚îÇ      ‚îÇ Rapira ‚îÇ      ‚îÇ Future ‚îÇ
    ‚îÇ Client ‚îÇ      ‚îÇ Client ‚îÇ      ‚îÇ Source ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                ‚îÇ                ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ FX Rates ‚îÇ
                    ‚îÇ  Service ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                ‚îÇ                ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Markup  ‚îÇ      ‚îÇ  Sync  ‚îÇ      ‚îÇ  Web   ‚îÇ
   ‚îÇ  Rules  ‚îÇ      ‚îÇ   Log  ‚îÇ      ‚îÇ Admin  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   FX     ‚îÇ
                    ‚îÇScheduler ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### Grinex

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –ø–∞—Ä:
- USDTRUB (USDT/RUB)
- BTCUSDT (BTC/USDT)

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä—É:

```sql
INSERT INTO fx_source_pair (source_id, source_symbol, base_currency, quote_currency, internal_symbol, enabled)
SELECT id, 'ETHRUB', 'ETH', 'RUB', 'ETH/RUB', true
FROM fx_source WHERE code = 'grinex';
```

### Rapira

–¢–∞–∫–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏:
- usdtrub (USDT/RUB)
- btcusdt (BTC/USDT)

**–í–∞–∂–Ω–æ**: —Å–∏–º–≤–æ–ª—ã –≤ Rapira –æ–±—ã—á–Ω–æ lowercase!

## üí∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ (–¥–ª—è –≤—Å–µ—Ö)

```sql
INSERT INTO fx_markup_rule (level, percent, fixed, enabled, description)
VALUES ('global', 1.0, 0, true, 'Default 1% markup for all rates');
```

### –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ –±–∏—Ä–∂–µ

```sql
INSERT INTO fx_markup_rule (level, source_id, percent, fixed, enabled, description)
SELECT 'source', id, 1.5, 5.0, true, 'Grinex: 1.5% + 5 RUB'
FROM fx_source WHERE code = 'grinex';
```

### –ù–∞—Ü–µ–Ω–∫–∞ –ø–æ –ø–∞—Ä–µ

```sql
INSERT INTO fx_markup_rule (level, source_id, source_pair_id, percent, fixed, enabled, description)
SELECT 'pair', sp.source_id, sp.id, 2.0, 10.0, true, 'USDT/RUB special: 2% + 10 RUB'
FROM fx_source_pair sp
JOIN fx_source s ON s.id = sp.source_id
WHERE s.code = 'grinex' AND sp.internal_symbol = 'USDT/RUB';
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Web Admin URLs

- **Sources**: http://localhost:8000/admin/fx/sources
- **Markup Rules**: http://localhost:8000/admin/fx/markup-rules
- **Current Rates**: http://localhost:8000/admin/fx/rates
- **Sync Logs**: http://localhost:8000/admin/fx/logs

### API Endpoints

```bash
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫—É—Ä—Å—ã
curl http://localhost:8000/api/fx/rates

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫—É—Ä—Å
curl "http://localhost:8000/api/fx/rates?base=USDT&quote=RUB&source=grinex"

# –¢—Ä–∏–≥–≥–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
curl -X POST http://localhost:8000/api/fx/sync

# –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
curl http://localhost:8000/api/fx/scheduler/status
```

### –õ–æ–≥–∏

```bash
# –õ–æ–≥–∏ –±–æ—Ç–∞ (–≤–∫–ª—é—á–∞—è FX)
docker-compose logs -f bot | grep FX

# –õ–æ–≥–∏ –≤–µ–±-–∞–¥–º–∏–Ω–∫–∏
docker-compose logs -f webadmin
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
docker-compose exec bot pytest tests/test_fx_rates.py -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≥—Ä—É–ø–ø—É
docker-compose exec bot pytest tests/test_fx_rates.py::TestMarkupCalculations -v
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (sources, pairs, rules) —Å TTL 5 –º–∏–Ω—É—Ç
- ‚úÖ Bulk –∑–∞–ø—Ä–æ—Å—ã –∫ API (–≥–¥–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ë–î –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö
- ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ –ø–∞—Ä—É –≤ fx_raw_rate –∏ fx_final_rate (UPSERT)
- ‚úÖ Connection pooling –¥–ª—è –ë–î

### –ú–µ—Ç—Ä–∏–∫–∏
- Latency –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- Stale –∫—É—Ä—Å—ã
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- % —É—Å–ø–µ—à–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö admin —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- ‚úÖ –°–µ–∫—Ä–µ—Ç—ã –≤ ENV (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è HMAC –∫–ª—é—á–∏)
- ‚úÖ SQL injection –∑–∞—â–∏—Ç–∞ (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üêõ Troubleshooting

### –ö—É—Ä—Å—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
curl http://localhost:8000/api/fx/scheduler/status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs bot | grep "FX sync"

# –¢—Ä–∏–≥–≥–µ—Ä –≤—Ä—É—á–Ω—É—é
curl -X POST http://localhost:8000/api/fx/sync
```

### –û—à–∏–±–∫–∏ API

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
docker-compose logs bot | grep "Grinex\|Rapira"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –∞–¥–º–∏–Ω–∫–µ
# http://localhost:8000/admin/fx/logs
```

### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
SELECT * FROM fx_markup_rule WHERE enabled = true AND deleted_at IS NULL;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
SELECT fr.*, mr.description 
FROM fx_final_rate fr
LEFT JOIN fx_markup_rule mr ON mr.id = fr.applied_rule_id
WHERE fr.source_pair_id = 1;
```

## üéØ Roadmap / –£–ª—É—á—à–µ–Ω–∏—è

### –ë–ª–∏–∂–∞–π—à–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Grinex API URL (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∏–∑–≤–µ—Å—Ç–µ–Ω)
- [ ] WebSocket –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis –¥–ª—è final_rates

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ
- [ ] Circuit breaker –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- [ ] HMAC –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] –°–Ω–∞–ø—à–æ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- [ ] Grafana/Prometheus –º–µ—Ç—Ä–∏–∫–∏

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ
- [ ] ML –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞—Ü–µ–Ω–æ–∫
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
- [ ] Multi-region deployment
- [ ] Rate limiting API

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ**: `FX_RATES_README.md`
- **–ü—Ä–∏–º–µ—Ä—ã ENV**: `fx_env_example.txt`
- **–¢–µ—Å—Ç—ã**: `tests/test_fx_rates.py`
- **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î**: `migrations/004_fx_rates_system.sql`

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞

- [x] –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [x] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã
- [ ] –ê–¥–º–∏–Ω–∫–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è (http://localhost:8000/admin/fx/sources)
- [ ] –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –ö—É—Ä—Å—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ `/admin/fx/rates`
- [ ] API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `/api/fx/rates`
- [ ] –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏)

---

**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞**: 2025-10-13  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Production Ready

