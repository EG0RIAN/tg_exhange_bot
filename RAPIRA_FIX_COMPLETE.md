# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Rapira API

## –î–∞—Ç–∞: 14 –æ–∫—Ç—è–±—Ä—è 2025

---

## üéØ –ì–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

**–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π API Rapira –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```
https://api.rapira.net/market/exchange-plate-mini?symbol=USDT/RUB
```

**–ù–ï —Ç—Ä–µ–±—É—é—Ç—Å—è –±–æ–ª—å—à–µ:**
- ‚ùå `RAPIRA_API_KEY`
- ‚ùå `RAPIRA_API_SECRET`
- ‚ùå HMAC –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ PostgreSQL Connection Pool
**–ü—Ä–æ–±–ª–µ–º–∞:** `ERROR: sorry, too many clients already`

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω singleton –ø—É–ª –≤ `src/db.py`
- –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç: `max_size=20`
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –ø—É–ª

**–§–∞–π–ª:** `src/db.py`

---

### 2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rapira API
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä—ã–π –∫–ª–∏–µ–Ω—Ç —Ç—Ä–µ–±–æ–≤–∞–ª API credentials, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π endpoint `/market/exchange-plate-mini`
- –û–±–Ω–æ–≤–ª–µ–Ω `src/services/fx_rates.py` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `rapira_simple_client`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è metadata (JSON)

**–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `src/services/fx_rates.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `get_rapira_simple_client()`
- `src/services/rapira_simple.py` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API

---

### 3. ‚úÖ –°–∏–º–≤–æ–ª—ã —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä—ã (EUR/EUR, USD/RUB)

**–†–µ—à–µ–Ω–∏–µ:**
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å Rapira API
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä—ã:
  - `USDT/RUB`
  - `BTC/USDT`

**SQL:**
```sql
UPDATE fx_source_pair 
SET source_symbol = 'USDT/RUB' 
WHERE internal_symbol = 'USDT/RUB';
```

---

### 4. ‚úÖ –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∞ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω SQL –∑–∞–ø—Ä–æ—Å –≤ `best_rate.py`
- –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–∏—Å–∫ –ø–æ –¥–≤—É–º —à–∞–±–ª–æ–Ω–∞–º: `%{city}%` –∏ `%–≥–æ—Ä–æ–¥: {city}%`

**–§–∞–π–ª:** `src/services/best_rate.py`

---

### 5. ‚úÖ Grinex –æ—Ç–∫–ª—é—á–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** Grinex API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404

**–†–µ—à–µ–Ω–∏–µ:**
- –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω: `UPDATE fx_source SET enabled = false WHERE code = 'grinex'`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Rapira

---

## üìä –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã (live)

```
USDT/RUB:
  bid: 81.78 RUB
  ask: 81.82 RUB
  mid: 81.80 RUB

BTC/USDT:
  bid: 115172.50 USDT
  ask: 115252.00 USDT
  mid: 115212.25 USDT
```

**–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É —á–µ—Ä–µ–∑ FX Scheduler**

---

## üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç!)

| –ì–æ—Ä–æ–¥ | –ù–∞—Ü–µ–Ω–∫–∞ | –ü—Ä–∏–º–µ—Ä (USDT/RUB buy) |
|-------|---------|----------------------|
| –ú–æ—Å–∫–≤–∞ | 0% | 81.82 RUB |
| –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ | 0.3% | 82.07 RUB |
| –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ | 0.7% | 82.39 RUB |
| –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ | 0.8% | 82.47 RUB |
| –ö–∞–∑–∞–Ω—å | 0.9% | 82.56 RUB |
| **–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É** | **1.0%** | **82.64 RUB** |

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ –¥–ª—è –†–æ—Å—Ç–æ–≤–∞:**
```
–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å (Rapira): 81.82 RUB
–ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞: +1%
–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å: 81.82 * 1.01 = 82.64 RUB
```

---

## ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

### API –∫—É—Ä—Å—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è:
```bash
$ curl "https://api.rapira.net/market/exchange-plate-mini?symbol=USDT/RUB"
{
  "ask": {"items": [{"price": 81.82, "amount": 805.94}]},
  "bid": {"items": [{"price": 81.78, "amount": 888.77}]}
}
```

### FX —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:
```
INFO:src.services.fx_scheduler:FX sync rapira: 2/2 pairs, 4499ms
INFO:src.services.rapira_simple:Rapira base rate for USDT/RUB: ask=81.82, bid=81.78
INFO:src.services.rapira_simple:Rapira base rate for BTC/USDT: ask=115252.0, bid=115172.5
```

### –ì–æ—Ä–æ–¥—Å–∫–∏–µ –∫—É—Ä—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç:
```python
await get_best_city_rate('USDT/RUB', 'moscow', 'buy')
# {'final_rate': 81.82, 'markup_percent': 0.0}

await get_best_city_rate('USDT/RUB', 'rostov', 'buy')
# {'final_rate': 82.64, 'markup_percent': 1.0}
```

---

## üöÄ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∏–∑ Rapira** - –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
2. ‚úÖ **–•—Ä–∞–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤ –ë–î** - `fx_raw_rate` –∏ `fx_final_rate`
3. ‚úÖ **–ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
4. ‚úÖ **Telegram –±–æ—Ç** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º
5. ‚úÖ **Web –∞–¥–º–∏–Ω–∫–∞** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—Å–æ–≤
6. ‚úÖ **API endpoints** - `/api/city-rates/all`, `/api/rapira/base-rate`

---

## üìù –ß—Ç–æ –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è

- ‚ùå Rapira API credentials
- ‚ùå HMAC –ø–æ–¥–ø–∏—Å—å
- ‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grinex (–æ—Ç–∫–ª—é—á–µ–Ω)
- ‚ùå –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

## üéâ –ò—Ç–æ–≥

**–ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç!**

- –ö—É—Ä—Å—ã –ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ Rapira API
- –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- Connection pool —Å—Ç–∞–±–∏–ª–µ–Ω
- –í—Å–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

**–ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production!**

---

## üîç –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫—É—Ä—Å–æ–≤
docker-compose logs -f bot | grep "FX sync"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É—Ä—Å–æ–≤ Rapira
docker-compose logs -f bot | grep "Rapira base rate"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –∫—É—Ä—Å–æ–≤
docker-compose logs -f bot | grep "City rate"
```

---

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –ù–∞–∂–º–∏—Ç–µ "üí± –ö—É—Ä—Å—ã"
3. –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É)
4. –£–≤–∏–¥–∏—Ç–µ –∫—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π:
   - USDT/RUB: 82.64 RUB (–≤–º–µ—Å—Ç–æ –±–∞–∑–æ–≤—ã—Ö 81.82)

---

## üõ†Ô∏è –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `src/db.py` - singleton –ø—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
2. `src/services/fx_rates.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ Rapira API
3. `src/services/best_rate.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∞–≤–∏–ª –Ω–∞—Ü–µ–Ω–∫–∏
4. `migrations/` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä

---

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã. –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! ‚úÖ**

