# ✅ Динамические города и торговые пары

## Дата: 14 октября 2025

---

## 🎯 Что добавлено

### 1. **Управление городами**
- ➕ Добавление новых городов
- ✏️ Редактирование наценок
- 🗑️ Удаление городов
- 📊 Все города хранятся в БД таблице `cities`

### 2. **Управление торговыми парами**
- ➕ Добавление новых пар из Rapira/Grinex
- 🔗 Указание endpoint (символа в API)
- 🗑️ Удаление пар
- 📊 Автоматическая синхронизация с `trading_pairs`

### 3. **Обновления бота**
- 🤖 Динамическая загрузка городов из БД
- 🤖 Динамическая загрузка торговых пар из БД
- ⚡ Кэширование для производительности

---

## 📂 База данных

### Новая таблица `cities`:

```sql
CREATE TABLE cities (
    id SERIAL PRIMARY KEY,
    code VARCHAR(50) NOT NULL UNIQUE,      -- Код: moscow, spb, rostov
    name VARCHAR(255) NOT NULL,             -- Название: Москва, СПб
    markup_percent DECIMAL(10, 4) DEFAULT 0,-- Наценка %
    markup_fixed DECIMAL(20, 8) DEFAULT 0,  -- Фиксированная наценка
    enabled BOOLEAN DEFAULT true,            -- Активен ли город
    sort_order INTEGER DEFAULT 0,            -- Порядок отображения
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**Миграция:** `migrations/007_cities_table.sql`

---

## 🌐 API Endpoints

### Управление городами:

```http
GET    /api/cities              - Список всех городов
POST   /api/cities              - Создать город
PUT    /api/cities/{city_id}   - Обновить город
DELETE /api/cities/{city_id}   - Удалить город
```

**Пример запроса (создание города):**
```json
POST /api/cities
{
  "code": "voronezh",
  "name": "Воронеж",
  "markup_percent": 0.8,
  "markup_fixed": 0,
  "enabled": true
}
```

### Управление торговыми парами:

```http
GET    /api/fx/all-pairs           - Все пары из всех источников
POST   /api/fx/source-pairs        - Добавить пару
DELETE /api/fx/source-pairs/{id}   - Удалить пару
```

**Пример запроса (добавление пары):**
```json
POST /api/fx/source-pairs
{
  "source_code": "rapira",
  "source_symbol": "ETH/USDT",      // Как в API источника
  "internal_symbol": "ETH/USDT",    // Как в нашей системе
  "enabled": true
}
```

---

## 💻 UI - Универсальная панель

### Открыть:
`http://localhost:8000/admin/rates-management`

### Вкладка "Городские наценки":

```
┌─────────────────────────────────────────┐
│ Настройка наценок по городам            │
│                      [➕ Добавить город] │
├─────────────────────────────────────────┤
│ Москва            [  0.0  ] %  [🗑]     │
│ Санкт-Петербург   [  0.3  ] %  [🗑]     │
│ Ростов-на-Дону    [  1.0  ] %  [🗑]     │
│ Нижний Новгород   [  0.8  ] %  [🗑]     │
│ ...                                      │
├─────────────────────────────────────────┤
│           [💾 Сохранить изменения]      │
└─────────────────────────────────────────┘
```

**Кнопка "Добавить город":**
- Открывает модальное окно
- Вводите код (voronezh), название (Воронеж), наценку (0.8%)
- Нажимаете "Добавить"
- Город сразу появляется в списке и в боте!

### Вкладка "Торговые пары":

```
┌─────────────────────────────────────────────────┐
│ Управление торговыми парами  [➕ Добавить пару] │
├─────────────────────────────────────────────────┤
│ Пара     │ Источник │ API    │ Статус │ Курс  │
│──────────┼──────────┼────────┼────────┼───────│
│ USDT/RUB │ rapira   │USDT/RUB│ ✓     │ 81.82 │
│ BTC/USDT │ rapira   │BTC/USDT│ ✓     │115173 │
└─────────────────────────────────────────────────┘
```

**Кнопка "Добавить пару":**
- Открывает модальное окно
- Выбираете источник (Rapira или Grinex)
- Вводите внутренний символ (ETH/USDT)
- Вводите символ в API (ETH/USDT или ethusdt)
- Нажимаете "Добавить"
- Пара добавляется и начинает синхронизироваться!

---

## 🤖 Обновления бота

### Динамические города:

**Было (статично):**
```python
CITIES = {'moscow': 'Москва', 'rostov': 'Ростов', ...}
```

**Стало (динамично):**
```python
# Города загружаются из БД
async def get_cities_keyboard():
    cities = await conn.fetch("SELECT code, name FROM cities WHERE enabled=true")
    # Генерируем кнопки динамически
```

**Результат:** 
- Добавили город в админке → он сразу появляется в боте!
- Изменили наценку → пересчитываются курсы автоматически!

### Динамические пары:

**Было:**
- Пары захардкожены в коде

**Стало:**
- Пары читаются из `fx_source_pair`
- Функция `get_pairs_for_fsm()` уже работала с БД

**Результат:**
- Добавили пару в админке → она появляется в боте!
- Удалили пару → исчезает из бота!

---

## 📝 Примеры использования

### Пример 1: Добавить город "Сочи" с наценкой 1.2%

1. Откройте `/admin/rates-management`
2. Вкладка "Городские наценки"
3. Нажмите "➕ Добавить город"
4. Заполните:
   - Код: `sochi`
   - Название: `Сочи`
   - Наценка: `1.2`
   - Активен: ✓
5. Нажмите "Добавить"

**Готово!** Город появился:
- ✅ В админке (вкладка "Городские наценки")
- ✅ В таблице курсов (вкладка "Текущие курсы")
- ✅ В Telegram боте (кнопка "🏖 Сочи")

### Пример 2: Добавить пару ETH/USDT из Rapira

1. Откройте `/admin/rates-management`
2. Вкладка "Торговые пары"
3. Нажмите "➕ Добавить пару"
4. Заполните:
   - Источник: `Rapira Exchange`
   - Внутренний символ: `ETH/USDT`
   - Символ в API: `ETH/USDT`
   - Активна: ✓
5. Нажмите "Добавить"

**Готово!** Пара добавлена:
- ✅ Синхронизация курсов начнется через минуту
- ✅ Появится в селекторе "Торговая пара"
- ✅ Появится в боте при создании заявки

---

## 🔧 Технические детали

### Изменённые файлы:

**Backend:**
- `migrations/007_cities_table.sql` - новая таблица
- `src/web_admin/main.py` - API endpoints
- `src/services/rapira_simple.py` - чтение из cities таблицы
- `src/services/best_rate.py` - чтение из cities таблицы

**Frontend:**
- `src/web_admin/templates/rates_management.html` - модальные окна, JavaScript

**Bot:**
- `src/keyboards.py` - динамическая клавиатура городов
- `src/handlers/fsm_request.py` - чтение названия города из БД
- `src/handlers/menu.py` - await для get_cities_keyboard()

### Кэширование:

Для производительности используется кэш:
- Города кэшируются на 60 секунд
- При добавлении/удалении кэш автоматически инвалидируется

---

## ✅ Что работает

### Города:
- ✅ Добавление через UI (модальное окно)
- ✅ Редактирование наценки (input + кнопка "Сохранить")
- ✅ Удаление (кнопка "🗑 Удалить")
- ✅ Автоматическое отображение в боте
- ✅ Автоматический пересчет курсов

### Торговые пары:
- ✅ Добавление через UI (модальное окно)
- ✅ Указание источника (Rapira/Grinex)
- ✅ Указание символа API (ETH/USDT или ethusdt)
- ✅ Удаление пары
- ✅ Автоматическая синхронизация курсов
- ✅ Автоматическое добавление в `trading_pairs`
- ✅ Автоматическое отображение в боте

### Telegram бот:
- ✅ Динамические кнопки городов
- ✅ Динамический список пар при создании заявки
- ✅ Динамическое отображение курсов
- ✅ Кэширование для быстрой работы

---

## 🚀 Тестирование

### 1. Проверка городов:

```bash
# В админке
1. Откройте http://localhost:8000/admin/rates-management
2. Вкладка "Городские наценки"
3. Нажмите "Добавить город"
4. Добавьте Воронеж с наценкой 0.8%

# В боте
1. Откройте бота в Telegram
2. Нажмите "💱 Курсы"
3. Увидите кнопку "🏙 Воронеж"!
```

### 2. Проверка пар:

```bash
# В админке
1. Вкладка "Торговые пары"
2. Нажмите "Добавить пару"
3. Добавьте ETH/USDT из Rapira

# В боте
1. Откройте бота
2. "✉️ Оставить заявку"
3. Выберите город
4. Увидите "ETH/USDT" в списке пар!
```

---

## 📊 SQL для проверки

```sql
-- Все города
SELECT code, name, markup_percent, enabled FROM cities ORDER BY sort_order;

-- Все пары
SELECT 
    sp.internal_symbol,
    s.name as source,
    sp.source_symbol,
    sp.enabled
FROM fx_source_pair sp
JOIN fx_source s ON sp.source_id = s.id
ORDER BY sp.internal_symbol;
```

---

## 🎉 Итог

**Было:** Статичные списки городов и пар в коде  
**Стало:** Полностью управляемые через админку

**Преимущества:**
- Не нужно менять код для добавления города
- Не нужно перезапускать бота
- Не нужны миграции для новых пар
- Всё управляется через UI

**Готово к использованию! 🚀**

