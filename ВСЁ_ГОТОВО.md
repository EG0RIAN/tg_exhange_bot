# ‚úÖ –í–°–Å –ì–û–¢–û–í–û!

## üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

```
Rapira API + Grinex API
         ‚Üì
  –õ—É—á—à–∏–π –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å
         ‚Üì
–ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ (—Ñ–∏–∫—Å/–ø—Ä–æ—Ü–µ–Ω—Ç)
         ‚Üì
  –§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –∫–ª–∏–µ–Ω—Ç—É
```

## üìä –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫—É—Ä—Å–æ–≤
- ‚úÖ Rapira API: —Ä–∞–±–æ—Ç–∞–µ—Ç (81.81 ‚ÇΩ)
- ‚ö†Ô∏è Grinex API: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (fallback –Ω–∞ Rapira)

### –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
- ‚úÖ USDT/RUB (–¥–ª—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
- ‚úÖ BTC/USDT (–¥–ª—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
- ‚úÖ USD/RUB (–¥–ª—è –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

### –ì–æ—Ä–æ–¥–∞ —Å –Ω–∞—Ü–µ–Ω–∫–∞–º–∏
1. –ú–æ—Å–∫–≤–∞: 0%
2. –°–ü–±: +0.3%
3. –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥: +0.7%
4. –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥: +0.8%
5. –ö–∞–∑–∞–Ω—å: +0.9%
6. –†–æ—Å—Ç–æ–≤: +1%
7. –î—Ä—É–≥–∏–µ: +1.5%

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ (–†–æ—Å—Ç–æ–≤, USDT/RUB)
```
Rapira: 81.81 ‚ÇΩ (–ª—É—á—à–µ —á–µ–º Grinex –∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω)
–ù–∞—Ü–µ–Ω–∫–∞ –†–æ—Å—Ç–æ–≤–∞: +1%
–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å: 81.81 √ó 1.01 = 82.63 ‚ÇΩ
```

## ü§ñ –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–æ—Ç–µ

### –ö–Ω–æ–ø–∫–∞ "üí± –ö—É—Ä—Å—ã"
```
1. –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (7 –∫–Ω–æ–ø–æ–∫)
2. –ö—É—Ä—Å—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞:
   
   USDT/RUB:
     –ü–æ–∫—É–ø–∫–∞: 82.63 ‚ÇΩ
     –ü—Ä–æ–¥–∞–∂–∞: 82.57 ‚ÇΩ
     –ò—Å—Ç–æ—á–Ω–∏–∫: RAPIRA
     –ù–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞: +1%
```

### –ö–Ω–æ–ø–∫–∞ "‚úâÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
```
1. –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞
2. –í—ã–±–æ—Ä –ø–∞—Ä—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–∞—à –∫—É—Ä—Å
   üí∞ –í–∞—à –∫—É—Ä—Å: 82.63 ‚ÇΩ
   ‚îî –ë–∞–∑–æ–≤—ã–π: 81.81 ‚ÇΩ
   ‚îî –ù–∞—Ü–µ–Ω–∫–∞: +1%
   ‚îî –ò—Å—Ç–æ—á–Ω–∏–∫: RAPIRA
3. –°—É–º–º–∞, –≤—ã–ø–ª–∞—Ç–∞, –∫–æ–Ω—Ç–∞–∫—Ç
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
5. –ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å –≥–æ—Ä–æ–¥–æ–º –∏ –∫—É—Ä—Å–æ–º
```

## üîß –î–ª—è –∞–¥–º–∏–Ω–∞

### Web Admin: http://localhost:8000/admin/city-rates

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üìä –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Ü–µ–Ω–æ–∫ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
- ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ 1 –∫–ª–∏–∫
- üó∫ –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∫—É—Ä—Å–∞–º–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
- üí∞ –ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å Rapira (Ask/Bid/Spread)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```
1. –ù–∞–∂–∞—Ç—å "–ò–∑–º–µ–Ω–∏—Ç—å" —É –†–æ—Å—Ç–æ–≤–∞
2. –í–≤–µ—Å—Ç–∏ 1.2 (–≤–º–µ—Å—Ç–æ 1.0)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
4. –ö–ª–∏–µ–Ω—Ç—ã –∏–∑ –†–æ—Å—Ç–æ–≤–∞ —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç 82.79 ‚ÇΩ
```

### –î—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª—ã
- `/admin/fx/markup-rules` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- `/admin/orders` - –∑–∞—è–≤–∫–∏ (—Å –≥–æ—Ä–æ–¥–æ–º –∫–ª–∏–µ–Ω—Ç–∞)
- `/admin/fx/sources` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Rapira/Grinex
- –í—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã

## üìù –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–∫–∏

‚úÖ **–¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–º–∏–≥—Ä–∞—Ü–∏—è 006)  
‚úÖ **–§–æ—Ä–º–∞—Ç –ø–∞—Ä** - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (USDT/RUB —Å —Å–ª—ç—à–µ–º)  
‚úÖ **–í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞** - –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π flow  
‚úÖ **–õ—É—á—à–∏–π –∫—É—Ä—Å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä Rapira vs Grinex  
‚úÖ **–ü–∞—Ä—Å–∏–Ω–≥ Rapira** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã (81.81 –≤–º–µ—Å—Ç–æ 99999)  
‚úÖ **API endpoints** - query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–º–µ—Å—Ç–æ path  
‚úÖ **rate_snapshot** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ  
‚úÖ **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥** - —É–¥–∞–ª–µ–Ω (~500 —Å—Ç—Ä–æ–∫)  

## üé® –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞—à–±–æ—Ä–¥–∞

```
http://localhost:8000/admin

–ü–µ—Ä–≤—ã–π —Ä—è–¥:
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏] [–ó–∞—è–≤–∫–∏] [Live —á–∞—Ç—ã] [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è]

–í—Ç–æ—Ä–æ–π —Ä—è–¥ (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):
[Grinex]  [FX System]  [Markup Rules]  [–ö—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º] ‚≠ê
```

## üîë –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã (3 —Ñ–∞–π–ª–∞)
1. `src/services/client_rates.py` - –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å
2. `src/services/best_rate.py` - –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∫—É—Ä—Å–∞
3. `src/services/rapira_simple.py` - –±–∞–∑–æ–≤—ã–µ –∫—É—Ä—Å—ã Rapira

### –ú–∏–≥—Ä–∞—Ü–∏–∏ (3 —Ñ–∞–π–ª–∞)
4. `migrations/004_fx_rates_system.sql` - FX –º–æ–¥—É–ª—å
5. `migrations/005_city_markups.sql` - –Ω–∞—Ü–µ–Ω–∫–∏ –≥–æ—Ä–æ–¥–æ–≤
6. `migrations/006_sync_trading_pairs.sql` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞—Ä

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ handlers (3 —Ñ–∞–π–ª–∞)
7. `src/handlers/fsm_request.py` - –∑–∞—è–≤–∫–∞ —Å –≥–æ—Ä–æ–¥–æ–º
8. `src/handlers/menu.py` - –∫—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º
9. `src/fsm.py` - ChooseCity state

### –£–¥–∞–ª–µ–Ω–æ
10. `src/handlers/admin_rapira.py` - –≤–µ—Å—å —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω

## üß™ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API
```bash
curl "http://localhost:8000/api/test/rapira-base-rate?symbol=USDT/RUB"
# ‚úÖ –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: {"success": true, "best_ask": 81.81}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä
```bash
docker-compose exec postgres psql -U exchange -d exchange \
  -c "SELECT DISTINCT internal_symbol FROM fx_source_pair WHERE enabled=true;"
# ‚úÖ –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: USDT/RUB, BTC/USDT, USD/RUB
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫
```bash
docker-compose exec postgres psql -U exchange -d exchange \
  -c "SELECT COUNT(*) FROM fx_markup_rule WHERE description ILIKE '%–≥–æ—Ä–æ–¥%';"
# ‚úÖ –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 7
```

## üöÄ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

### Web Admin
```
http://localhost:8000/admin/city-rates
```
–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏–∑ .env

### Telegram Bot
```
–ù–∞–∂–º–∏—Ç–µ "üí± –ö—É—Ä—Å—ã" –∏–ª–∏ "‚úâÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥
–£–≤–∏–¥–∏—Ç–µ –∫—É—Ä—Å—ã —Å –Ω–∞—Ü–µ–Ω–∫–æ–π
```

### API
```bash
curl "http://localhost:8000/api/test/rapira-base-rate?symbol=USDT/RUB"
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –î–ª—è –∫–æ–≥–æ |
|------|----------|
| `–ò–¢–û–ì–û.md` | –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ |
| `–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø.md` | –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `FINAL_VERIFICATION.md` | –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ |
| `CLIENT_FLOW_UPDATE.md` | –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ |
| `CITY_RATES_README.md` | –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ |
| `READY_TO_USE.md` | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| `–¢–ï–°–¢.md` | –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è |

---

## üéâ –ü–†–û–ï–ö–¢ –ì–û–¢–û–í!

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
- ‚úÖ –í—Å–µ –Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ Rapira API —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–∞—Ü–µ–Ω–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π flow –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –ê–¥–º–∏–Ω–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞

### –†–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫—É—Ä—Å–æ–≤ (Rapira + Grinex)
- ‚úÖ –í—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –∫—É—Ä—Å–∞
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–æ–∫
- ‚úÖ –ü–æ–∫–∞–∑ –∫—É—Ä—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞–º
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ —Å –≥–æ—Ä–æ–¥–æ–º
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ!** üöÄ

