# City Rates - –ö—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º —Å –Ω–∞—Ü–µ–Ω–∫–∞–º–∏

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—Å–∞–º–∏ Rapira:

1. **–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å** - –ø–æ–ª—É—á–∞–µ–º –∏–∑ Rapira API (–º–æ—Å–∫–æ–≤—Å–∫–∏–π –∫—É—Ä—Å)
2. **–ù–∞—Ü–µ–Ω–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É** - –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é –Ω–∞–¥–±–∞–≤–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–æ—Ä–æ–¥–∞
3. **–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å** - –æ—Ç–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É

```
–ú–æ—Å–∫–≤–∞:           81.83 ‚ÇΩ + 0%   = 81.83 ‚ÇΩ  (–±–∞–∑–æ–≤—ã–π)
–°–ü–±:              81.83 ‚ÇΩ + 0.3% = 82.08 ‚ÇΩ
–†–æ—Å—Ç–æ–≤:           81.83 ‚ÇΩ + 1%   = 82.65 ‚ÇΩ
–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥:  81.83 ‚ÇΩ + 0.8% = 82.48 ‚ÇΩ
–î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞:    81.83 ‚ÇΩ + 1.5% = 83.06 ‚ÇΩ
```

## üìä –§–æ—Ä–º—É–ª–∞

```python
final_rate = base_rate * (1 + markup_percent/100) + fixed
```

**–ì–¥–µ:**
- `base_rate` - –∫—É—Ä—Å –∏–∑ Rapira API (best ask –∏–ª–∏ best bid)
- `markup_percent` - –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å 0)
- `fixed` - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞ (–æ–±—ã—á–Ω–æ 0)

## üåç –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞

| –ì–æ—Ä–æ–¥ | –ö–æ–¥ | –ù–∞—Ü–µ–Ω–∫–∞ | –ü—Ä–∏–º–µ—Ä (–æ—Ç 81.83 ‚ÇΩ) |
|-------|-----|---------|----------------------|
| –ú–æ—Å–∫–≤–∞ | `moscow` | 0% | 81.83 ‚ÇΩ |
| –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ | `spb` | +0.3% | 82.08 ‚ÇΩ |
| –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ | `ekaterinburg` | +0.7% | 82.40 ‚ÇΩ |
| –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ | `nizhniy_novgorod` | +0.8% | 82.48 ‚ÇΩ |
| –ö–∞–∑–∞–Ω—å | `kazan` | +0.9% | 82.57 ‚ÇΩ |
| –†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É | `rostov` | +1.0% | 82.65 ‚ÇΩ |
| –î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞ | `other` | +1.5% | 83.06 ‚ÇΩ |

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Web Admin

–û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:8000/admin/city-rates

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å–∞
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –ª—é–±–æ–≥–æ –≥–æ—Ä–æ–¥–∞
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ –í—ã–±–æ—Ä –ø–∞—Ä—ã (USDT/RUB, BTC/USDT –∏ —Ç.–¥.)

### REST API

#### –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

```bash
GET /api/city-rate/{city}/{symbol}?operation=buy

# –ü—Ä–∏–º–µ—Ä
curl "http://localhost:8000/api/city-rate/rostov/USDT%2FRUB?operation=buy"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "symbol": "USDT/RUB",
  "city": "rostov",
  "base_rate": 81.83,
  "markup_percent": 1.0,
  "markup_fixed": 0.0,
  "final_rate": 82.65,
  "operation": "buy",
  "timestamp": "2025-10-13T16:30:00"
}
```

#### –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã –¥–ª—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤

```bash
GET /api/city-rates/all/{symbol}?operation=buy

# –ü—Ä–∏–º–µ—Ä
curl "http://localhost:8000/api/city-rates/all/USDT%2FRUB?operation=buy"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "symbol": "USDT/RUB",
  "operation": "buy",
  "cities": {
    "moscow": {
      "city": "moscow",
      "base_rate": 81.83,
      "final_rate": 81.83,
      "markup_percent": 0.0
    },
    "rostov": {
      "city": "rostov",
      "base_rate": 81.83,
      "final_rate": 82.65,
      "markup_percent": 1.0
    },
    ...
  },
  "timestamp": "2025-10-13T16:30:00"
}
```

#### –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å –∏–∑ Rapira

```bash
GET /api/rapira/base-rate/{symbol}

# –ü—Ä–∏–º–µ—Ä
curl "http://localhost:8000/api/rapira/base-rate/USDT%2FRUB"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "symbol": "USDT/RUB",
  "best_ask": 81.83,
  "best_bid": 81.50,
  "timestamp": "2025-10-13T16:30:00"
}
```

### Python API

```python
from src.services.rapira_simple import get_city_rate, get_rapira_simple_client

# –ü–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å –¥–ª—è –†–æ—Å—Ç–æ–≤–∞
rate = await get_city_rate("USDT/RUB", "rostov", "buy")
print(f"–ö—É—Ä—Å –¥–ª—è –†–æ—Å—Ç–æ–≤–∞: {rate['final_rate']} ‚ÇΩ")
print(f"–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å: {rate['base_rate']} ‚ÇΩ")
print(f"–ù–∞—Ü–µ–Ω–∫–∞: {rate['markup_percent']}%")

# –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å –∏–∑ Rapira
client = await get_rapira_simple_client()
base_data = await client.get_base_rate("USDT/RUB")
print(f"–ú–æ—Å–∫–≤–∞ ask: {base_data['best_ask']}")
print(f"–ú–æ—Å–∫–≤–∞ bid: {base_data['best_bid']}")
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
docker-compose exec postgres psql -U exchange -d exchange -f /app/migrations/005_city_markups.sql
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –Ω–æ–≤—ã–µ)

```sql
INSERT INTO fx_markup_rule (level, percent, fixed, enabled, description, rounding_mode, round_to)
VALUES ('global', 1.2, 0, true, '–ù–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –≥–æ—Ä–æ–¥–∞: krasnodar (–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä)', 'ROUND_HALF_UP', 2);
```

### 3. –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≥–æ—Ä–æ–¥–∞

**–ß–µ—Ä–µ–∑ Web Admin:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8000/admin/city-rates
2. –ù–∞–∂–º–∏—Ç–µ "–ò–∑–º–µ–Ω–∏—Ç—å" –Ω–∞–ø—Ä–æ—Ç–∏–≤ –≥–æ—Ä–æ–¥–∞
3. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –Ω–∞—Ü–µ–Ω–∫—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–ß–µ—Ä–µ–∑ SQL:**
```sql
UPDATE fx_markup_rule
SET percent = 1.2
WHERE description ILIKE '%–≥–æ—Ä–æ–¥: rostov%';
```

**–ß–µ—Ä–µ–∑ API:**
```bash
curl -X POST http://localhost:8000/api/city-rates/update-markup \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "city=rostov&percent=1.2"
```

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä: –ö–ª–∏–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç USDT –≤ –†–æ—Å—Ç–æ–≤–µ

1. **–ó–∞–ø—Ä–æ—Å –∫ Rapira API:**
   ```
   GET https://api.rapira.net/market/exchange-plate-mini?symbol=USDT/RUB
   ```

2. **–ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å (best ask):**
   ```
   best_ask = 81.83 ‚ÇΩ
   ```

3. **–ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Ü–µ–Ω–∫—É –†–æ—Å—Ç–æ–≤–∞ (+1%):**
   ```
   final_rate = 81.83 * (1 + 1.0/100)
   final_rate = 81.83 * 1.01
   final_rate = 82.65 ‚ÇΩ
   ```

4. **–û—Ç–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É:**
   ```
   –ö—É—Ä—Å –¥–ª—è –†–æ—Å—Ç–æ–≤–∞: 82.65 ‚ÇΩ
   ```

### –ü—Ä–∏–º–µ—Ä: –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–∞–µ—Ç USDT –≤ –ù–∏–∂–Ω–µ–º –ù–æ–≤–≥–æ—Ä–æ–¥–µ

1. **–ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—ã–π –∫—É—Ä—Å (best bid):**
   ```
   best_bid = 81.50 ‚ÇΩ
   ```

2. **–ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Ü–µ–Ω–∫—É (+0.8%):**
   ```
   final_rate = 81.50 * 1.008 = 82.15 ‚ÇΩ
   ```

## üé® Web Admin Interface

### –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/city-rates`

**–í–µ—Ä—Ö–Ω—è—è —Å–µ–∫—Ü–∏—è - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫:**
- –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏
- –ö–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞
- –°—Ç–∞—Ç—É—Å (–ê–∫—Ç–∏–≤–Ω–æ/–í—ã–∫–ª)
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**–°—Ä–µ–¥–Ω—è—è —Å–µ–∫—Ü–∏—è - –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã:**
- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞
- –ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å (–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π)
- –§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å (–±–æ–ª—å—à–æ–π, –∑–µ–ª–µ–Ω—ã–π)
- Badge —Å –Ω–∞—Ü–µ–Ω–∫–æ–π (—Ü–≤–µ—Ç–Ω–æ–π –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é)
- –í—ã–±–æ—Ä –ø–∞—Ä—ã (USDT/RUB, BTC/USDT –∏ —Ç.–¥.)

**–ù–∏–∂–Ω—è—è —Å–µ–∫—Ü–∏—è - –ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å Rapira:**
- Best Ask (–ø–æ–∫—É–ø–∫–∞)
- Best Bid (–ø—Ä–æ–¥–∞–∂–∞)
- –°–ø—Ä–µ–¥

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í—Å–µ API endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞—Ü–µ–Ω–∫–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –∫—É—Ä—Å–∞

```bash
# –ß–µ—Ä–µ–∑ API
curl "http://localhost:8000/api/rapira/base-rate/USDT%2FRUB"

# –ù–∞–ø—Ä—è–º—É—é –∏–∑ Rapira
curl "https://api.rapira.net/market/exchange-plate-mini?symbol=USDT/RUB" | jq '.ask.lowestPrice'
```

### –õ–æ–≥–∏

```bash
# –õ–æ–≥–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
docker-compose logs webadmin | grep "Rapira base rate"

# –õ–æ–≥–∏ –Ω–∞—Ü–µ–Ω–æ–∫
docker-compose logs webadmin | grep "City rate for"
```

## ‚ùì FAQ

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥?

```sql
INSERT INTO fx_markup_rule (level, percent, fixed, enabled, description, rounding_mode, round_to)
VALUES ('global', 1.3, 0, true, '–ù–∞—Ü–µ–Ω–∫–∞ –¥–ª—è –≥–æ—Ä–æ–¥–∞: sochi (–°–æ—á–∏)', 'ROUND_HALF_UP', 2);
```

–ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å–ª–æ–≤–∞—Ä—å `CITIES` –≤ `src/services/rapira_simple.py`.

### –ö–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É –≥–æ—Ä–æ–¥–∞?

```sql
UPDATE fx_markup_rule
SET enabled = false
WHERE description ILIKE '%–≥–æ—Ä–æ–¥: rostov%';
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Web Admin - –∫–Ω–æ–ø–∫–∞ "–ò–∑–º–µ–Ω–∏—Ç—å" ‚Üí —Å–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É "–ê–∫—Ç–∏–≤–Ω–æ".

### –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É operation=buy –∏ operation=sell?

- **buy** - –∫–ª–∏–µ–Ω—Ç –ø–æ–∫—É–ø–∞–µ—Ç USDT, –ø–ª–∞—Ç–∏—Ç RUB ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º ask (—Ü–µ–Ω–∞ –≤—ã—à–µ)
- **sell** - –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ–¥–∞–µ—Ç USDT, –ø–æ–ª—É—á–∞–µ—Ç RUB ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º bid (—Ü–µ–Ω–∞ –Ω–∏–∂–µ)

### –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é –Ω–∞—Ü–µ–Ω–∫—É (—Å–∫–∏–¥–∫—É)?

–î–∞! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç:

```sql
UPDATE fx_markup_rule
SET percent = -0.5  -- —Å–∫–∏–¥–∫–∞ 0.5%
WHERE description ILIKE '%–≥–æ—Ä–æ–¥: moscow%';
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

- **Rapira Simple Client** (`src/services/rapira_simple.py`) - –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫—É—Ä—Å–æ–≤
- **FX Markup Rules** (`migrations/004_fx_rates_system.sql`) - —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Ü–µ–Ω–æ–∫
- **Web Admin** (`src/web_admin/main.py`) - API endpoints
- **City Rates Page** (`templates/city_rates.html`) - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é: `migrations/005_city_markups.sql`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose restart webadmin`
3. –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:8000/admin/city-rates

---

**–ü—Ä–æ—Å—Ç–æ. –ü–æ–Ω—è—Ç–Ω–æ. –ì–∏–±–∫–æ.** üöÄ

