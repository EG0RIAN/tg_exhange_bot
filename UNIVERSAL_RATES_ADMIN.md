# ✅ Универсальная панель управления курсами

## Дата: 14 октября 2025

---

## 🎯 Что добавлено

Создана **единая универсальная страница** для управления всеми курсами валют, наценками и источниками данных.

### Вместо нескольких разделов:
- ❌ FX Sources
- ❌ FX Source Pairs  
- ❌ FX Markup Rules
- ❌ FX Rates
- ❌ City Rates
- ❌ Grinex Management

### Теперь один раздел:
- ✅ **Управление курсами** - все в одном месте

---

## 🚀 Как открыть

### 1. Через главную страницу админки

Откройте: `http://localhost:8000/admin`

На главной странице появилась большая фиолетовая карточка:

```
┌─────────────────────────────────────────────┐
│   💱 Управление курсами                     │
│                                              │
│   Единая панель для управления курсами      │
│   валют, городскими наценками и             │
│   источниками данных                        │
│                                              │
│   [Открыть панель управления]               │
└─────────────────────────────────────────────┘
```

### 2. Прямая ссылка

`http://localhost:8000/admin/rates-management`

---

## 📊 Что внутри

### Вкладка 1: Текущие курсы

**Что показывает:**
- Курсы для всех городов
- Базовый курс из Rapira
- Наценка по городу
- Финальный курс для клиента
- Источник данных

**Пример таблицы:**

| Город | Базовый курс | Наценка | Финальный курс | Источник |
|-------|-------------|---------|----------------|----------|
| Москва | 81.82 RUB | 0% | 81.82 RUB | rapira |
| Санкт-Петербург | 81.82 RUB | 0.3% | 82.07 RUB | rapira |
| Ростов-на-Дону | 81.82 RUB | 1.0% | 82.64 RUB | rapira |

**Фильтры:**
- Выбор торговой пары: `USDT/RUB`, `BTC/USDT`
- Автообновление каждые 30 секунд

---

### Вкладка 2: Городские наценки

**Что можно делать:**
- ✏️ Изменить процент наценки для любого города
- 💾 Сохранить все изменения одной кнопкой

**Интерфейс:**

```
Москва               [  0.0  ] %    Текущая наценка: 0%
Санкт-Петербург      [  0.3  ] %    Текущая наценка: 0.3%
Ростов-на-Дону       [  1.0  ] %    Текущая наценка: 1.0%
Нижний Новгород      [  0.8  ] %    Текущая наценка: 0.8%
Екатеринбург         [  0.7  ] %    Текущая наценка: 0.7%
Казань               [  0.9  ] %    Текущая наценка: 0.9%
Другие города        [  1.5  ] %    Текущая наценка: 1.5%

                [💾 Сохранить изменения]
```

**Как использовать:**
1. Измените значение наценки (например, с 1.0% на 1.5%)
2. Нажмите "Сохранить изменения"
3. Курсы автоматически пересчитаются

---

### Вкладка 3: Источники данных

**Что показывает:**
- ✅ Rapira Exchange - состояние (включен/выключен)
- ✅ Grinex Exchange - состояние (включен/выключен)
- 📊 Последние синхронизации - история

**Управление:**
- Переключатель on/off для каждого источника
- Кнопка "Синхронизировать" для принудительного обновления

**История синхронизаций:**

| Источник | Время | Пары | Статус | Длительность |
|----------|-------|------|--------|--------------|
| Rapira | 00:14:14 | 2/2 | success | 4499 мс |
| Rapira | 00:13:14 | 2/2 | success | 3892 мс |

---

## 🎨 Преимущества

### До:
```
Админка
├── FX Sources (2 клика)
├── FX Source Pairs (2 клика)
├── FX Markup Rules (2 клика)
│   └── Создать правило (3 клика)
│       └── Заполнить форму (10 полей)
├── FX Rates (2 клика)
├── City Rates (2 клика)
└── Grinex Management (2 клика)

Итого: 6 разделов, ~20 кликов
```

### После:
```
Админка
└── Управление курсами (1 клик)
    ├── Вкладка: Текущие курсы
    ├── Вкладка: Городские наценки → изменить → сохранить (2 клика)
    └── Вкладка: Источники данных

Итого: 1 раздел, 3 клика
```

**Экономия: 85% кликов и времени!**

---

## 🔧 API endpoints

Добавлены новые API endpoints:

```
GET  /api/fx/sources           - Список источников
PUT  /api/fx/sources/{code}    - Включить/выключить источник
GET  /api/fx/logs              - Логи синхронизации
GET  /api/fx/markup-rules      - Правила наценок
```

---

## 📱 Как использовать (примеры)

### Пример 1: Изменить наценку для Москвы

1. Откройте `/admin/rates-management`
2. Перейдите на вкладку "Городские наценки"
3. Найдите "Москва", измените с `0%` на `0.5%`
4. Нажмите "Сохранить изменения"
5. Вернитесь на вкладку "Текущие курсы" - курс для Москвы изменился!

### Пример 2: Отключить Grinex

1. Откройте `/admin/rates-management`
2. Перейдите на вкладку "Источники данных"
3. Найдите "Grinex Exchange"
4. Переключите switcher в положение OFF
5. Grinex отключен, используется только Rapira

### Пример 3: Просмотр курсов

1. Откройте `/admin/rates-management`
2. Вкладка "Текущие курсы" уже открыта
3. Выберите пару: `USDT/RUB` или `BTC/USDT`
4. Видите курсы для всех городов в одной таблице
5. Страница автоматически обновляется каждые 30 секунд

---

## 🎯 Технические детали

### Файлы:

**Frontend:**
- `src/web_admin/templates/rates_management.html` - HTML страница
- Использует Bootstrap 5 + Bootstrap Icons
- JavaScript для динамической загрузки данных

**Backend:**
- `src/web_admin/main.py` - API endpoints
- Добавлен роут `@app.get("/admin/rates-management")`
- 4 новых API метода

**Database:**
- Использует существующие таблицы: `fx_source`, `fx_markup_rule`, `fx_sync_log`
- Никаких миграций не требуется

### Дизайн:

- Градиентный фиолетовый дизайн (фирменный стиль)
- Адаптивный (работает на мобильных)
- Интуитивно понятный интерфейс
- Автообновление без перезагрузки страницы

---

## ✅ Что работает

- ✅ Просмотр текущих курсов для всех городов
- ✅ Изменение городских наценок одной кнопкой
- ✅ Включение/выключение источников данных
- ✅ История синхронизаций
- ✅ Автообновление данных
- ✅ Принудительная синхронизация
- ✅ Фильтрация по торговым парам

---

## 🚀 Следующие шаги

1. Откройте `http://localhost:8000/admin`
2. Нажмите на большую фиолетовую карточку "Управление курсами"
3. Изучите 3 вкладки
4. Попробуйте изменить наценку для любого города
5. Проверьте как изменился курс во вкладке "Текущие курсы"

---

## 📸 Скриншоты (описание)

### Главная страница админки:
```
┌──────────────────────────────────┐
│  💱  Управление курсами          │
│  Единая панель для управления... │
│  [Открыть панель управления]     │
└──────────────────────────────────┘
```

### Универсальная панель:
```
┌─────────────────────────────────────────────┐
│ 💱 Управление курсами               [Синхронизировать] [На главную] │
│ Единая панель для управления...                                     │
│ ● Синхронизация активна | Последнее: 2 мин назад                  │
├─────────────────────────────────────────────┤
│ [Текущие курсы] [Городские наценки] [Источники] │
├─────────────────────────────────────────────┤
│                                              │
│  Торговая пара: [USDT/RUB ▼]                │
│                                              │
│  Город  | База | Наценка | Финал | Источник│
│  ────────────────────────────────────────── │
│  Москва | 81.82 | 0%     | 81.82 | rapira  │
│  Ростов | 81.82 | 1%     | 82.64 | rapira  │
│                                              │
└─────────────────────────────────────────────┘
```

---

**Все готово! Удобная панель управления курсами работает! 🎉**

