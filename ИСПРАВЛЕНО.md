# Исправленные проблемы бота

## Дата: 14 октября 2025

### 1. ❌ Проблема: PostgreSQL Connection Pool Exhausted
**Симптомы:**
```
ERROR: sorry, too many clients already
```

**Причина:** 
`get_pg_pool()` создавал новый connection pool при каждом вызове вместо переиспользования единого пула.

**Решение:**
- Создан глобальный singleton пул `_pg_pool`
- Увеличен лимит connections: `max_size=20` (было 10)
- Исправлен файл: `src/db.py`

### 2. ❌ Проблема: Неправильные торговые пары
**Симптомы:**
```
trading_pairs содержал: EUR/EUR, USD/RUB
```

**Причина:**
Несинхронизация между `trading_pairs` и `fx_source_pair`

**Решение:**
- Удалены неправильные пары (EUR/EUR, USD/RUB)
- Синхронизированы правильные пары из `fx_source_pair`: 
  - `USDT/RUB`
  - `BTC/USDT`

### 3. ❌ Проблема: Rapira API возвращает пустые данные
**Симптомы:**
```
ERROR:src.services.fx_scheduler:FX sync rapira failed: ['usdtrub: no data', 'btcusdt: no data']
Successfully imported 0/0 rates from Rapira
```

**Причина:**
Отсутствуют credentials для Rapira API:
- `RAPIRA_API_KEY` - не установлен
- `RAPIRA_API_SECRET` - не установлен

**Временное решение:**
- Добавлены тестовые курсы в базу данных
- USDT/RUB: 93.50 (bid: 93.40, ask: 93.60)
- BTC/USDT: 65000 (bid: 64950, ask: 65050)
- С наценкой 2%: USDT/RUB → 95.37, BTC/USDT → 66300

**⚠️ ТРЕБУЕТСЯ ОТ ПОЛЬЗОВАТЕЛЯ:**
Добавьте в `.env` файл:
```bash
RAPIRA_API_KEY=your_actual_api_key
RAPIRA_API_SECRET=your_actual_api_secret
```

### 4. ✅ Проблема: Grinex API 404 ошибки
**Симптомы:**
```
ERROR:src.services.grinex:Failed to get ticker for USDRUB: Client error '404 Not Found'
```

**Решение:**
- Grinex отключен: `UPDATE fx_source SET enabled = false WHERE code = 'grinex'`
- Временно используется только Rapira как источник курсов

### 5. ⚠️ Telegram Conflict (не критично)
**Симптомы:**
```
ERROR:aiogram.dispatcher:Failed to fetch updates - TelegramConflictError: terminated by other getUpdates request
```

**Причина:**
Бот уже запущен на production сервере

**Решение:**
Остановите production бота перед запуском локально или используйте другой bot token для разработки.

---

## Текущий статус ✅

- ✅ Connection pool исправлен
- ✅ Торговые пары синхронизированы (USDT/RUB, BTC/USDT)
- ✅ Тестовые курсы в базе данных
- ✅ Grinex отключен (временно)
- ⏳ Ожидаются Rapira API credentials

## Следующие шаги

1. **Добавьте Rapira credentials в `.env`:**
   ```bash
   RAPIRA_API_KEY=your_key
   RAPIRA_API_SECRET=your_secret
   ```

2. **Перезапустите Docker контейнеры:**
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

3. **Проверьте логи:**
   ```bash
   docker-compose logs -f bot | grep "Successfully imported"
   ```

4. **(Опционально) Включите Grinex обратно если нужно:**
   ```sql
   UPDATE fx_source SET enabled = true WHERE code = 'grinex';
   ```

## Протестировано

- ✅ База данных работает
- ✅ Connection pool стабилен
- ✅ Торговые пары корректны
- ✅ Тестовые курсы отображаются
- ⏳ Синхронизация с Rapira API (требуются credentials)

