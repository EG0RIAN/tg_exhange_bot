<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Тестирование Rapira API - Админ-панель</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .test-card {
            transition: all 0.3s ease;
            border-left: 4px solid #17a2b8;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .test-result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        .test-result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .test-result.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .test-result.info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }
        .vwap-calculator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .result-display {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            background: rgba(255,255,255,0.8);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="bi bi-shield-check"></i> Админка
            </a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle"></i> {{ user }}
                </span>
                <a href="/logout" class="btn btn-outline-light">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-flask"></i> Тестирование Rapira API</h1>
            <div>
                <a href="/rapira" class="btn btn-outline-primary me-2">
                    <i class="bi bi-graph-up-arrow"></i> Статус
                </a>
                <a href="/rapira/settings" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-gear"></i> Настройки
                </a>
                <a href="/admin" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Назад в админку
                </a>
            </div>
        </div>
        <p class="text-muted">Проверка работоспособности API и тестирование VWAP расчетов</p>

        <!-- VWAP Calculator -->
        <div class="vwap-calculator">
            <h3 class="text-center mb-4"><i class="bi bi-calculator me-2"></i>VWAP Калькулятор</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="vwap_pair" class="form-label">Торговая пара</label>
                        <select class="form-select" id="vwap_pair">
                            <option value="USDT/RUB">USDT/RUB</option>
                            <option value="BTC/USDT">BTC/USDT</option>
                            <option value="EUR/USDT">EUR/USDT</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="vwap_amount" class="form-label">Сумма (USD)</label>
                        <input type="number" class="form-control" id="vwap_amount" 
                               min="1000" max="1000000" step="1000" value="50000">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="vwap_operation" class="form-label">Операция</label>
                        <select class="form-select" id="vwap_operation">
                            <option value="cash_in">CASH_IN (покупка USDT)</option>
                            <option value="cash_out">CASH_OUT (продажа USDT)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="vwap_location" class="form-label">Локация</label>
                        <select class="form-select" id="vwap_location">
                            <option value="moscow">Москва</option>
                            <option value="spb">Санкт-Петербург</option>
                            <option value="other">Другие города</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-light btn-lg" onclick="calculateVWAP()">
                    <i class="bi bi-calculator me-2"></i>Рассчитать VWAP
                </button>
            </div>
            
            <!-- VWAP Results -->
            <div id="vwap-results" class="result-display" style="display: none;">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="metric-value" id="base-rate">-</div>
                        <div class="metric-label">Базовый курс</div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value" id="final-rate">-</div>
                        <div class="metric-label">Финальный курс</div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value" id="spread">-</div>
                        <div class="metric-label">Спред (%)</div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-value" id="source">-</div>
                        <div class="metric-label">Источник</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="progress-bar-custom">
                            <div class="progress-fill" id="spread-bar" style="width: 0%"></div>
                        </div>
                        <small class="text-center d-block mt-2">Визуализация спреда</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Tests -->
        <div class="row">
            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-globe me-2"></i>Тест API Endpoints</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-outline-info w-100 mb-2" onclick="testPlateMini()">
                                <i class="bi bi-layers me-2"></i>Тест Plate Mini API
                            </button>
                            <button class="btn btn-outline-info w-100 mb-2" onclick="testRatesAPI()">
                                <i class="bi bi-graph-up me-2"></i>Тест Rates API
                            </button>
                            <button class="btn btn-outline-info w-100" onclick="testHealthCheck()">
                                <i class="bi bi-heart-pulse me-2"></i>Тест Health Check
                            </button>
                        </div>
                        <div id="api-test-results">
                            <!-- Результаты тестов будут загружены сюда -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Тест интеграции</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-outline-success w-100 mb-2" onclick="testRateCalculation()">
                                <i class="bi bi-calculator me-2"></i>Тест расчета курса
                            </button>
                            <button class="btn btn-outline-success w-100 mb-2" onclick="testFallback()">
                                <i class="bi bi-shield-check me-2"></i>Тест fallback стратегии
                            </button>
                            <button class="btn btn-outline-success w-100" onclick="testCache()">
                                <i class="bi bi-database me-2"></i>Тест кэширования
                            </button>
                        </div>
                        <div id="integration-test-results">
                            <!-- Результаты тестов будут загружены сюда -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tests -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card test-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Тесты производительности</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="testLatency()">
                                    <i class="fas fa-clock me-2"></i>Тест задержки
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="testConcurrent()">
                                    <i class="fas fa-network-wired me-2"></i>Тест конкурентности
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="testMemory()">
                                    <i class="fas fa-memory me-2"></i>Тест памяти
                                </button>
                            </div>
                        </div>
                        <div id="performance-test-results">
                            <!-- Результаты тестов будут загружены сюда -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test History -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card test-card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>История тестов</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-history">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p>История тестов будет отображаться здесь</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для детального просмотра результатов -->
    <div class="modal fade" id="testDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Детали теста</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="test-details-content">
                    <!-- Содержимое будет загружено динамически -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testHistory = [];

        // VWAP Calculator
        async function calculateVWAP() {
            try {
                const pair = document.getElementById('vwap_pair').value;
                const amount = parseFloat(document.getElementById('vwap_amount').value);
                const operation = document.getElementById('vwap_operation').value;
                const location = document.getElementById('vwap_location').value;

                // Показываем индикатор загрузки
                document.getElementById('vwap-results').style.display = 'block';
                document.getElementById('base-rate').textContent = '...';
                document.getElementById('final-rate').textContent = '...';
                document.getElementById('spread').textContent = '...';
                document.getElementById('source').textContent = '...';

                const response = await fetch('/api/rapira/vwap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pair: pair,
                        amount_usd: amount,
                        operation: operation,
                        location: location
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Обновляем результаты
                    document.getElementById('base-rate').textContent = result.data.base_rate.toFixed(4);
                    document.getElementById('final-rate').textContent = result.data.final_rate.toFixed(4);
                    document.getElementById('spread').textContent = result.data.spread.toFixed(2) + '%';
                    document.getElementById('source').textContent = result.data.source;

                    // Обновляем прогресс-бар спреда
                    const spreadPercent = Math.abs(result.data.spread);
                    const maxSpread = 5; // Максимальный спред для визуализации
                    const barWidth = Math.min((spreadPercent / maxSpread) * 100, 100);
                    document.getElementById('spread-bar').style.width = barWidth + '%';

                    // Добавляем в историю
                    addTestToHistory('VWAP Calculation', 'success', `Pair: ${pair}, Amount: $${amount}, Operation: ${operation}`);
                } else {
                    showTestError('VWAP Calculation', result.error);
                }

            } catch (error) {
                console.error('Ошибка VWAP расчета:', error);
                showTestError('VWAP Calculation', 'Ошибка сети или сервера');
            }
        }

        // API Tests
        async function testPlateMini() {
            await runTest('Plate Mini API', '/api/rapira/test/plate-mini');
        }

        async function testRatesAPI() {
            await runTest('Rates API', '/api/rapira/test/rates');
        }

        async function testHealthCheck() {
            await runTest('Health Check', '/api/rapira/test/health');
        }

        // Integration Tests
        async function testRateCalculation() {
            await runTest('Rate Calculation', '/api/rapira/test/rate-calculation');
        }

        async function testFallback() {
            await runTest('Fallback Strategy', '/api/rapira/test/fallback');
        }

        async function testCache() {
            await runTest('Cache System', '/api/rapira/test/cache');
        }

        // Performance Tests
        async function testLatency() {
            await runTest('Latency Test', '/api/rapira/test/latency');
        }

        async function testConcurrent() {
            await runTest('Concurrency Test', '/api/rapira/test/concurrent');
        }

        async function testMemory() {
            await runTest('Memory Test', '/api/rapira/test/memory');
        }

        // Общая функция для запуска тестов
        async function runTest(testName, endpoint) {
            try {
                const startTime = Date.now();
                
                const response = await fetch(endpoint);
                const result = await response.json();
                
                const duration = Date.now() - startTime;
                
                if (result.success) {
                    showTestResult(testName, 'success', result.message, duration, result.data);
                    addTestToHistory(testName, 'success', result.message, duration);
                } else {
                    showTestResult(testName, 'error', result.error, duration);
                    addTestToHistory(testName, 'error', result.error, duration);
                }

            } catch (error) {
                console.error(`Ошибка теста ${testName}:`, error);
                showTestResult(testName, 'error', 'Ошибка сети или сервера');
                addTestToHistory(testName, 'error', 'Ошибка сети или сервера');
            }
        }

        // Показать результат теста
        function showTestResult(testName, status, message, duration = null, data = null) {
            const container = getTestContainer(testName);
            const statusClass = status === 'success' ? 'success' : 
                              status === 'warning' ? 'warning' : 'error';
            const statusIcon = status === 'success' ? 'fa-check-circle' : 
                             status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
            
            let html = `<div class="test-result ${statusClass}">`;
            html += `<h6><i class="fas ${statusIcon} me-2"></i>${testName}</h6>`;
            html += `<p class="mb-1">${message}</p>`;
            
            if (duration !== null) {
                html += `<small class="text-muted">Время выполнения: ${duration}мс</small>`;
            }
            
            if (data && Object.keys(data).length > 0) {
                html += `<button class="btn btn-sm btn-outline-secondary mt-2" onclick="showTestDetails('${testName}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">Детали</button>`;
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Получить контейнер для результатов теста
        function getTestContainer(testName) {
            if (testName.includes('API')) {
                return document.getElementById('api-test-results');
            } else if (testName.includes('integration') || testName.includes('Integration')) {
                return document.getElementById('integration-test-results');
            } else if (testName.includes('performance') || testName.includes('Performance')) {
                return document.getElementById('performance-test-results');
            }
            return document.getElementById('api-test-results');
        }

        // Показать детали теста
        function showTestDetails(testName, data) {
            const modal = document.getElementById('testDetailsModal');
            const content = document.getElementById('test-details-content');
            
            let html = `<h6>${testName}</h6>`;
            html += '<pre class="bg-light p-3 rounded"><code>' + JSON.stringify(data, null, 2) + '</code></pre>';
            
            content.innerHTML = html;
            
            new bootstrap.Modal(modal).show();
        }

        // Добавить тест в историю
        function addTestToHistory(testName, status, message, duration = null) {
            const test = {
                name: testName,
                status: status,
                message: message,
                duration: duration,
                timestamp: new Date().toISOString()
            };
            
            testHistory.unshift(test);
            
            // Ограничиваем историю 50 тестами
            if (testHistory.length > 50) {
                testHistory = testHistory.slice(0, 50);
            }
            
            updateTestHistory();
        }

        // Обновить отображение истории тестов
        function updateTestHistory() {
            const container = document.getElementById('test-history');
            
            if (testHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p>История тестов будет отображаться здесь</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Время</th><th>Тест</th><th>Статус</th><th>Сообщение</th><th>Длительность</th></tr></thead><tbody>';
            
            testHistory.forEach(test => {
                const statusClass = test.status === 'success' ? 'text-success' : 
                                  test.status === 'warning' ? 'text-warning' : 'text-danger';
                const statusIcon = test.status === 'success' ? 'fa-check-circle' : 
                                 test.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
                
                html += `<tr>
                    <td><small>${new Date(test.timestamp).toLocaleTimeString()}</small></td>
                    <td><strong>${test.name}</strong></td>
                    <td><i class="fas ${statusIcon} ${statusClass}"></i> ${test.status}</td>
                    <td><small>${test.message}</small></td>
                    <td>${test.duration ? test.duration + 'мс' : '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Показать ошибку теста
        function showTestError(testName, error) {
            showTestResult(testName, 'error', error);
            addTestToHistory(testName, 'error', error);
        }

        // Очистить историю тестов
        function clearTestHistory() {
            testHistory = [];
            updateTestHistory();
        }
    </script>
</body>
</html>
