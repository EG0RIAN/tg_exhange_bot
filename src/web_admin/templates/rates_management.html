<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏ - Admin Panel</title>
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 15px;
        }
        .header-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .rate-badge {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-block;
            margin: 5px;
        }
        .rate-badge.rapira {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .rate-badge.grinex {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .city-row {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .city-row:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        .markup-input {
            width: 100px;
            display: inline-block;
            margin: 0 10px;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }
        .tab-content {
            padding-top: 20px;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 600;
        }
        .nav-tabs .nav-link.active {
            color: #764ba2;
            border-bottom: 3px solid #764ba2;
        }
        .rate-table {
            font-size: 0.95rem;
        }
        .rate-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0"><i class="bi bi-currency-exchange"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏</h2>
                    <p class="text-muted mb-0">–ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞–º–∏ –≤–∞–ª—é—Ç –∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="syncNow()">
                        <i class="bi bi-arrow-clockwise"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <a href="/admin" class="btn btn-outline-secondary">
                        <i class="bi bi-house"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                </div>
            </div>
            
            <!-- Sync Status -->
            <div class="sync-status mt-3" id="syncStatus">
                <span class="status-badge success">
                    <i class="bi bi-check-circle"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞
                </span>
                <span class="text-muted" id="lastSync">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="section-card">
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates" type="button">
                        <i class="bi bi-graph-up"></i> –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="markup-tab" data-bs-toggle="tab" data-bs-target="#markup" type="button">
                        <i class="bi bi-percent"></i> –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pairs-tab" data-bs-toggle="tab" data-bs-target="#pairs" type="button">
                        <i class="bi bi-arrow-left-right"></i> –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button">
                        <i class="bi bi-database"></i> –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabsContent">
                <!-- Tab 1: –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã -->
                <div class="tab-pane fade show active" id="rates" role="tabpanel">
                    <h5 class="mb-3">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ –≥–æ—Ä–æ–¥–∞–º</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞:</label>
                            <select class="form-select" id="pairSelect" onchange="loadRates()">
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                            </select>
                        </div>
                        <div class="col-md-8 text-muted">
                            <small><i class="bi bi-info-circle"></i> –ü–∞—Ä—ã –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –≤–∫–ª–∞–¥–∫–∏ "–¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã"</small>
                        </div>
                    </div>

                    <table class="table rate-table table-hover">
                        <thead>
                            <tr>
                                <th>–ì–æ—Ä–æ–¥</th>
                                <th>–ë–∞–∑–æ–≤—ã–π –∫—É—Ä—Å (Rapira)</th>
                                <th>–ù–∞—Ü–µ–Ω–∫–∞</th>
                                <th>–§–∏–Ω–∞–ª—å–Ω—ã–π –∫—É—Ä—Å</th>
                                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tab 2: –ì–æ—Ä–æ–¥—Å–∫–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ -->
                <div class="tab-pane fade" id="markup" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—Ü–µ–Ω–æ–∫ –ø–æ –≥–æ—Ä–æ–¥–∞–º</h5>
                            <p class="text-muted mb-0">–ò–∑–º–µ–Ω—è–π—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddCityModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥
                        </button>
                    </div>

                    <div id="markupContainer">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è -->
                    </div>

                    <button class="btn btn-save mt-3" onclick="saveMarkups()">
                        <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    
                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ü–µ–Ω–æ–∫ –ø–æ –ø–∞—Ä–∞–º -->
                    <div class="modal fade" id="pairMarkupsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="pairMarkupsTitle">–ù–∞—Ü–µ–Ω–∫–∏ –ø–æ –ø–∞—Ä–∞–º</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –ø–∞—Ä. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ –≥–æ—Ä–æ–¥–∞.</p>
                                    <div id="pairMarkupsContainer"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞ -->
                    <div class="modal fade" id="addCityModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">–ö–æ–¥ –≥–æ—Ä–æ–¥–∞ (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π):</label>
                                        <input type="text" class="form-control" id="newCityCode" placeholder="voronezh">
                                        <small class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL –∏ –∫–æ–¥–µ</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:</label>
                                        <input type="text" class="form-control" id="newCityName" placeholder="–í–æ—Ä–æ–Ω–µ–∂">
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É (%):</label>
                                            <input type="number" class="form-control" id="newCityMarkupBuy" value="-1.0" step="0.1">
                                            <small class="text-muted">–ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">–ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É (%):</label>
                                            <input type="number" class="form-control" id="newCityMarkupSell" value="1.0" step="0.1">
                                            <small class="text-muted">–ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫:</label>
                                        <select class="form-control" id="newCitySource">
                                            <option value="">–õ—é–±–æ–π (–∞–≤—Ç–æ–≤—ã–±–æ—Ä)</option>
                                            <option value="rapira">Rapira</option>
                                            <option value="grinex">Grinex</option>
                                        </select>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newCityEnabled" checked>
                                        <label class="form-check-label" for="newCityEnabled">–ê–∫—Ç–∏–≤–µ–Ω</label>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="button" class="btn btn-primary" onclick="addCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: –¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã -->
                <div class="tab-pane fade" id="pairs" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–∏</h5>
                            <p class="text-muted mb-0">–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–∞—Ä—ã –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddPairModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É
                        </button>
                    </div>

                    <table class="table rate-table table-hover">
                        <thead>
                            <tr>
                                <th>–ü–∞—Ä–∞</th>
                                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th>–°–∏–º–≤–æ–ª API</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫—É—Ä—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="pairsTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—ã -->
                    <div class="modal fade" id="addPairModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é –ø–∞—Ä—É</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                                        <select class="form-select" id="newPairSourceSelect">
                                            <option value="rapira">Rapira Exchange</option>
                                            <option value="grinex">Grinex Exchange</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∏–º–≤–æ–ª (—Ñ–æ—Ä–º–∞—Ç A/B):</label>
                                        <input type="text" class="form-control" id="newPairInternal" placeholder="ETH/USDT">
                                        <small class="text-muted">–ö–∞–∫ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">–°–∏–º–≤–æ–ª –≤ API –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</label>
                                        <input type="text" class="form-control" id="newPairSourceSymbol" placeholder="ETH/USDT –∏–ª–∏ ethusdt">
                                        <small class="text-muted">–§–æ—Ä–º–∞—Ç —Å–∏–º–≤–æ–ª–∞ –≤ API –∏—Å—Ç–æ—á–Ω–∏–∫–∞</small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newPairEnabled" checked>
                                        <label class="form-check-label">–ê–∫—Ç–∏–≤–Ω–∞</label>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="button" class="btn btn-primary" onclick="addPair()">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 4: –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="tab-pane fade" id="sources" role="tabpanel">
                    <h5 class="mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∫—É—Ä—Å–æ–≤</h5>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="city-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="rate-badge rapira">Rapira Exchange</span>
                                        </h6>
                                        <p class="text-muted mb-0 small">
                                            –ü—É–±–ª–∏—á–Ω—ã–π API: <code>api.rapira.net</code>
                                        </p>
                                        <p class="mb-0 small" id="rapiraStatus">–°—Ç–∞—Ç—É—Å: –ø—Ä–æ–≤–µ—Ä–∫–∞...</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="rapiraEnabled" onchange="toggleSource('rapira', this.checked)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="city-row">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="rate-badge grinex">Grinex Exchange</span>
                                        </h6>
                                        <p class="text-muted mb-0 small">
                                            API: <code>api.grinex.io</code>
                                        </p>
                                        <p class="mb-0 small" id="grinexStatus">–°—Ç–∞—Ç—É—Å: –ø—Ä–æ–≤–µ—Ä–∫–∞...</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="grinexEnabled" onchange="toggleSource('grinex', this.checked)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h5>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–ü–∞—Ä—ã</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="syncLogsBody">
                            <tr>
                                <td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const cities = {
            'moscow': '–ú–æ—Å–∫–≤–∞',
            'spb': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
            'rostov': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
            'nizhniy_novgorod': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
            'ekaterinburg': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
            'kazan': '–ö–∞–∑–∞–Ω—å',
            'other': '–î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞'
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            updatePairSelector().then(() => {
                loadRates();
            });
            loadMarkups();
            loadSources();
            loadSyncLogs();
            updateLastSync();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateLastSync, 30000);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –∫—É—Ä—Å–æ–≤
        let loadingRates = false;
        
        async function loadRates() {
            if (loadingRates) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            loadingRates = true;
            
            const pair = document.getElementById('pairSelect').value;
            const tbody = document.getElementById('ratesTableBody');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div></td></tr>';
            
            try {
                const response = await fetch(`/api/city-rates/all?symbol=${encodeURIComponent(pair)}`, {
                    cache: 'no-cache' // –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.rates && Object.keys(data.rates).length > 0) {
                    let html = '';
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    const cityOrder = ['moscow', 'spb', 'rostov', 'nizhniy_novgorod', 'ekaterinburg', 'kazan', 'other'];
                    
                    cityOrder.forEach(city => {
                        if (data.rates[city]) {
                            const cityData = data.rates[city];
                            const cityName = cities[city] || city;
                            html += `
                                <tr>
                                    <td><strong>${cityName}</strong></td>
                                    <td>${cityData.base_rate ? cityData.base_rate.toFixed(2) : 'N/A'}</td>
                                    <td><span class="badge bg-info">${cityData.markup_percent ? cityData.markup_percent.toFixed(1) : 0}%</span></td>
                                    <td><strong class="text-success">${cityData.final_rate ? cityData.final_rate.toFixed(2) : 'N/A'}</strong></td>
                                    <td><span class="rate-badge ${cityData.best_source || 'rapira'}">${cityData.best_source || 'rapira'}</span></td>
                                </tr>
                            `;
                        }
                    });
                    
                    tbody.innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-warning text-center">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</td></tr>';
                console.error('Error loading rates:', error);
            } finally {
                loadingRates = false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ü–µ–Ω–æ–∫
        async function loadMarkups() {
            const container = document.getElementById('markupContainer');
            
            try {
                const response = await fetch('/api/cities');
                const citiesData = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç cities
                citiesData.forEach(city => {
                    cities[city.code] = city.name;
                });
                
                let html = '';
                citiesData.forEach(city => {
                    const sourceIcon = city.preferred_source === 'rapira' ? 'üü¢' : (city.preferred_source === 'grinex' ? 'üîµ' : '‚ö™');
                    const sourceName = city.preferred_source === 'rapira' ? 'Rapira' : (city.preferred_source === 'grinex' ? 'Grinex' : '–ê–≤—Ç–æ');
                    
                    html += `
                        <div class="city-row">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <strong>${city.name}</strong>
                                    <br><small class="text-muted">${city.code}</small>
                                    <br><small class="text-muted">${sourceIcon} ${sourceName}</small>
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">–ü–æ–∫—É–ø–∫–∞:</span>
                                        <input type="number" 
                                               class="form-control markup-input" 
                                               id="markup_buy_${city.code}" 
                                               value="${city.markup_buy}" 
                                               step="0.1"
                                               data-city-id="${city.id}"
                                               data-field="markup_buy">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">–ü—Ä–æ–¥–∞–∂–∞:</span>
                                        <input type="number" 
                                               class="form-control markup-input" 
                                               id="markup_sell_${city.code}" 
                                               value="${city.markup_sell}" 
                                               step="0.1"
                                               data-city-id="${city.id}"
                                               data-field="markup_sell">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${city.enabled ? 'bg-success' : 'bg-secondary'}">
                                        ${city.enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω'}
                                    </span>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="showPairMarkups(${city.id}, '${city.name}', '${city.code}')">
                                        <i class="bi bi-sliders"></i> –ü–æ –ø–∞—Ä–∞–º
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCity(${city.id}, '${city.name}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html || '<div class="alert alert-info">–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥.</div>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π
                document.querySelectorAll('.markup-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const cityId = e.target.getAttribute('data-city-id');
                        const field = e.target.getAttribute('data-field');
                        const value = parseFloat(e.target.value);
                        
                        try {
                            await fetch(`/api/cities/${cityId}`, {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    [field]: value
                                })
                            });
                            e.target.style.borderColor = '#198754';
                            setTimeout(() => { e.target.style.borderColor = ''; }, 1000);
                        } catch (error) {
                            e.target.style.borderColor = '#dc3545';
                            console.error('Error saving markup:', error);
                        }
                    });
                });
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤</div>';
                console.error('Error loading markups:', error);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Ü–µ–Ω–æ–∫ (—É—Å—Ç–∞—Ä–µ–ª–æ - —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
        async function saveMarkups() {
            alert('‚úÖ –ù–∞—Ü–µ–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        async function loadSources() {
            try {
                const response = await fetch('/api/fx/sources');
                const sources = await response.json();
                
                sources.forEach(source => {
                    const checkbox = document.getElementById(`${source.code}Enabled`);
                    if (checkbox) {
                        checkbox.checked = source.enabled;
                    }
                    
                    const status = document.getElementById(`${source.code}Status`);
                    if (status) {
                        const statusText = source.enabled ? 
                            `<span class="text-success">‚úì –ê–∫—Ç–∏–≤–µ–Ω</span>` : 
                            `<span class="text-muted">‚óã –û—Ç–∫–ª—é—á–µ–Ω</span>`;
                        status.innerHTML = `–°—Ç–∞—Ç—É—Å: ${statusText}`;
                    }
                });
            } catch (error) {
                console.error('Error loading sources:', error);
            }
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        async function toggleSource(code, enabled) {
            try {
                await fetch(`/api/fx/sources/${code}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: enabled})
                });
                
                loadSources();
                setTimeout(loadRates, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
                console.error(error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        async function loadSyncLogs() {
            try {
                const response = await fetch('/api/fx/logs?limit=10');
                const logs = await response.json();
                
                const tbody = document.getElementById('syncLogsBody');
                let html = '';
                
                logs.forEach(log => {
                    const statusClass = log.status === 'success' ? 'success' : 
                                      log.status === 'partial' ? 'warning' : 'error';
                    const time = new Date(log.started_at).toLocaleString('ru-RU');
                    
                    html += `
                        <tr>
                            <td><span class="rate-badge ${log.source_code}">${log.source_name}</span></td>
                            <td>${time}</td>
                            <td>${log.pairs_succeeded}/${log.pairs_processed}</td>
                            <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                            <td>${log.duration_ms} –º—Å</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            } catch (error) {
                console.error('Error loading sync logs:', error);
            }
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        async function syncNow() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            
            try {
                await fetch('/api/fx/sync', {method: 'POST'});
                alert('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!');
                setTimeout(() => {
                    loadRates();
                    loadSyncLogs();
                }, 3000);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        async function updateLastSync() {
            try {
                const response = await fetch('/api/fx/logs?limit=1');
                const logs = await response.json();
                
                if (logs.length > 0) {
                    const lastLog = logs[0];
                    const time = new Date(lastLog.started_at);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - time) / 60000);
                    
                    const timeText = diffMinutes < 1 ? '—Ç–æ–ª—å–∫–æ —á—Ç–æ' : 
                                   diffMinutes < 60 ? `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥` : 
                                   `${Math.floor(diffMinutes/60)} —á –Ω–∞–∑–∞–¥`;
                    
                    document.getElementById('lastSync').textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeText}`;
                }
            } catch (error) {
                console.error('Error updating last sync:', error);
            }
        }

        // ============================================================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ì–û–†–û–î–ê–ú–ò
        // ============================================================================

        function showAddCityModal() {
            const modal = new bootstrap.Modal(document.getElementById('addCityModal'));
            modal.show();
        }

        async function addCity() {
            const code = document.getElementById('newCityCode').value.trim();
            const name = document.getElementById('newCityName').value.trim();
            const markupBuy = parseFloat(document.getElementById('newCityMarkupBuy').value);
            const markupSell = parseFloat(document.getElementById('newCityMarkupSell').value);
            const preferredSource = document.getElementById('newCitySource').value || null;
            const enabled = document.getElementById('newCityEnabled').checked;
            
            if (!code || !name) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–¥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
                return;
            }
            
            try {
                const response = await fetch('/api/cities', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        code: code,
                        name: name,
                        markup_buy: markupBuy,
                        markup_sell: markupSell,
                        markup_fixed: 0,
                        preferred_source: preferredSource,
                        enabled: enabled
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ –ì–æ—Ä–æ–¥ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω!`);
                    bootstrap.Modal.getInstance(document.getElementById('addCityModal')).hide();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newCityCode').value = '';
                    document.getElementById('newCityName').value = '';
                    document.getElementById('newCityMarkup').value = '0.5';
                    document.getElementById('newCityEnabled').checked = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                    loadMarkups();
                    loadRates();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ cities –æ–±—ä–µ–∫—Ç
                    cities[code] = name;
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞: ' + error.message);
            }
        }

        async function deleteCity(cityId, cityName) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ "${cityName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/cities/${cityId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ –ì–æ—Ä–æ–¥ —É–¥–∞–ª—ë–Ω`);
                    loadMarkups();
                    loadRates();
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
        }

        async function showPairMarkups(cityId, cityName, cityCode) {
            document.getElementById('pairMarkupsTitle').textContent = `–ù–∞—Ü–µ–Ω–∫–∏ –ø–æ –ø–∞—Ä–∞–º: ${cityName}`;
            
            const container = document.getElementById('pairMarkupsContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–∞—Ä—ã
                const pairsResponse = await fetch('/api/fx/all-pairs');
                const pairs = await pairsResponse.json();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Ü–µ–Ω–∫–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞
                const markupsResponse = await fetch(`/api/city-pair-markups?city_id=${cityId}`);
                const existingMarkups = await markupsResponse.json();
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é –Ω–∞—Ü–µ–Ω–∫—É –≥–æ—Ä–æ–¥–∞
                const citiesResponse = await fetch('/api/cities');
                const citiesData = await citiesResponse.json();
                const cityData = citiesData.find(c => c.id === cityId);
                const baseMarkupBuy = cityData ? cityData.markup_buy : 0;
                const baseMarkupSell = cityData ? cityData.markup_sell : 0;
                
                let html = `
                    <div class="alert alert-info">
                        <strong>–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏ –≥–æ—Ä–æ–¥–∞:</strong> –ü–æ–∫—É–ø–∫–∞: ${baseMarkupBuy}% / –ü—Ä–æ–¥–∞–∂–∞: ${baseMarkupSell}%<br>
                        <small>–ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–∞—Ä–∞–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞</small>
                    </div>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞</th>
                                <th>–ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É (%)</th>
                                <th>–ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É (%)</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã
                const uniquePairs = [...new Set(pairs.map(p => p.internal_symbol))];
                
                uniquePairs.forEach(pairSymbol => {
                    const existing = existingMarkups.find(m => m.pair_symbol === pairSymbol);
                    const currentMarkupBuy = existing ? existing.markup_buy : '';
                    const currentMarkupSell = existing ? existing.markup_sell : '';
                    
                    html += `
                        <tr>
                            <td><strong>${pairSymbol}</strong></td>
                            <td>
                                <div class="input-group input-group-sm" style="max-width: 180px;">
                                    <input type="number" 
                                           class="form-control" 
                                           id="pair_markup_buy_${cityId}_${pairSymbol.replace('/', '_')}"
                                           value="${currentMarkupBuy}"
                                           placeholder="${baseMarkupBuy}"
                                           step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="max-width: 180px;">
                                    <input type="number" 
                                           class="form-control" 
                                           id="pair_markup_sell_${cityId}_${pairSymbol.replace('/', '_')}"
                                           value="${currentMarkupSell}"
                                           placeholder="${baseMarkupSell}"
                                           step="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-success" onclick="savePairMarkup(${cityId}, '${pairSymbol}', '${cityCode}')">
                                    <i class="bi bi-check"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                                ${existing ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePairMarkup(${existing.id}, ${cityId})">
                                    <i class="bi bi-x"></i>
                                </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                const modal = new bootstrap.Modal(document.getElementById('pairMarkupsModal'));
                modal.show();
                
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                console.error(error);
            }
        }

        async function savePairMarkup(cityId, pairSymbol, cityCode) {
            const inputBuyId = `pair_markup_buy_${cityId}_${pairSymbol.replace('/', '_')}`;
            const inputSellId = `pair_markup_sell_${cityId}_${pairSymbol.replace('/', '_')}`;
            const inputBuy = document.getElementById(inputBuyId);
            const inputSell = document.getElementById(inputSellId);
            const valueBuy = inputBuy.value.trim();
            const valueSell = inputSell.value.trim();
            
            if (!valueBuy && !valueSell) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –Ω–∞—Ü–µ–Ω–∫—É –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ');
                return;
            }
            
            try {
                await fetch('/api/city-pair-markups', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        city_id: cityId,
                        pair_symbol: pairSymbol,
                        markup_buy: valueBuy ? parseFloat(valueBuy) : 0,
                        markup_sell: valueSell ? parseFloat(valueSell) : 0,
                        markup_fixed: 0
                    })
                });
                
                alert(`‚úÖ –ù–∞—Ü–µ–Ω–∫–∞ –¥–ª—è ${pairSymbol} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ –ø–∞—Ä–∞
                const currentPair = document.getElementById('pairSelect').value;
                if (currentPair === pairSymbol) {
                    loadRates();
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deletePairMarkup(markupId, cityId) {
            try {
                await fetch(`/api/city-pair-markups/${markupId}`, {
                    method: 'DELETE'
                });
                
                alert('‚úÖ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –Ω–∞—Ü–µ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è)');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const cityName = document.getElementById('pairMarkupsTitle').textContent.split(': ')[1];
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏ —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
                bootstrap.Modal.getInstance(document.getElementById('pairMarkupsModal')).hide();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // ============================================================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–†–ì–û–í–´–ú–ò –ü–ê–†–ê–ú–ò
        // ============================================================================

        async function loadPairs() {
            const tbody = document.getElementById('pairsTableBody');
            
            try {
                const response = await fetch('/api/fx/all-pairs');
                const pairs = await response.json();
                
                let html = '';
                pairs.forEach(pair => {
                    const statusBadge = pair.enabled ? 
                        '<span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞</span>' : 
                        '<span class="badge bg-secondary">–û—Ç–∫–ª—é—á–µ–Ω–∞</span>';
                    
                    const lastRate = pair.last_rate ? pair.last_rate.toFixed(2) : 'N/A';
                    
                    html += `
                        <tr>
                            <td><strong>${pair.internal_symbol}</strong></td>
                            <td><span class="rate-badge ${pair.source_code}">${pair.source_name}</span></td>
                            <td><code>${pair.source_symbol}</code></td>
                            <td>${statusBadge}</td>
                            <td>${lastRate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="deletePair(${pair.id}, '${pair.internal_symbol}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="6" class="text-center">–ù–µ—Ç –ø–∞—Ä</td></tr>';
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
                console.error('Error loading pairs:', error);
            }
        }

        function showAddPairModal() {
            const modal = new bootstrap.Modal(document.getElementById('addPairModal'));
            modal.show();
        }

        async function addPair() {
            const sourceCode = document.getElementById('newPairSourceSelect').value;
            const internalSymbol = document.getElementById('newPairInternal').value.trim().toUpperCase();
            const sourceSymbol = document.getElementById('newPairSourceSymbol').value.trim();
            const enabled = document.getElementById('newPairEnabled').checked;
            
            if (!internalSymbol || !sourceSymbol) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç A/B
            if (!internalSymbol.includes('/')) {
                alert('‚ùå –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∏–º–≤–æ–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ A/B (–Ω–∞–ø—Ä–∏–º–µ—Ä ETH/USDT)');
                return;
            }
            
            try {
                console.log('Adding pair:', {sourceCode, sourceSymbol, internalSymbol, enabled});
                
                const response = await fetch('/api/fx/source-pairs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source_code: sourceCode,
                        source_symbol: sourceSymbol,
                        internal_symbol: internalSymbol,
                        enabled: enabled
                    })
                });
                
                console.log('Response status:', response.status);
                
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º response —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —á–∏—Ç–∞—Ç—å body –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
                const responseClone = response.clone();
                let result;
                
                try {
                    result = await response.json();
                    console.log('Parsed result:', result);
                } catch (jsonError) {
                    // –ï—Å–ª–∏ –Ω–µ JSON - –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –∫–ª–æ–Ω–∞
                    const text = await responseClone.text();
                    console.error('Not JSON, text:', text);
                    alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${text.substring(0, 200)}`);
                    return;
                }
                
                if (!response.ok) {
                    // –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    const errorMsg = result.detail || result.error || JSON.stringify(result);
                    alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ' + errorMsg);
                    console.error('Server error:', result);
                    return;
                }
                
                if (result.success) {
                    alert(`‚úÖ –ü–∞—Ä–∞ "${internalSymbol}" –¥–æ–±–∞–≤–ª–µ–Ω–∞!`);
                    bootstrap.Modal.getInstance(document.getElementById('addPairModal')).hide();
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newPairInternal').value = '';
                    document.getElementById('newPairSourceSymbol').value = '';
                    document.getElementById('newPairEnabled').checked = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                    loadPairs();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–∞—Ä –≤ –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
                    updatePairSelector();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Exception:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä—ã: ' + error.message);
            }
        }

        async function deletePair(pairId, symbol) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É "${symbol}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/fx/source-pairs/${pairId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ –ü–∞—Ä–∞ —É–¥–∞–ª–µ–Ω–∞`);
                    loadPairs();
                    updatePairSelector();
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
        }

        async function updatePairSelector() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–∞—Ä –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã"
            const select = document.getElementById('pairSelect');
            const currentValue = select.value;
            
            try {
                const response = await fetch('/api/fx/all-pairs');
                const pairs = await response.json();
                
                select.innerHTML = '';
                pairs.forEach(pair => {
                    if (pair.enabled) {
                        const option = document.createElement('option');
                        option.value = pair.internal_symbol;
                        option.textContent = pair.internal_symbol;
                        select.appendChild(option);
                    }
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤–æ–µ
                if (Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                } else if (select.options.length > 0) {
                    select.value = select.options[0].value;
                }
            } catch (error) {
                console.error('Error updating pair selector:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        document.getElementById('pairs-tab').addEventListener('shown.bs.tab', function() {
            loadPairs();
        });
    </script>
</body>
</html>

